<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyYPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rajdhani', sans-serif;
            -ms-overflow-style: none; scrollbar-width: none;
            background-color: #000;
            overflow: hidden;
        }
        body::-webkit-scrollbar { display: none; }
        h1, h2, h3, h4, .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .xp-bar-progress { transition: width 0.5s ease-in-out; }
        .text-glow { text-shadow: 0 0 6px rgba(0, 255, 255, 0.7), 0 0 10px rgba(0, 255, 255, 0.5); }
        .modal {
            display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            animation: fadeIn 0.3s;
        }
        .modal-content { animation: slideIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Live Background */
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background: #01040a; }
        .stars, .twinkling, .clouds { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; display: block; }
        .stars { background: #000 url(https://www.script-tutorials.com/demos/360/images/stars.png) repeat top center; z-index: 0; }
        .twinkling { background: transparent url(https://www.script-tutorials.com/demos/360/images/twinkling.png) repeat top center; z-index: 1; animation: move-twink-back 200s linear infinite; }
        .clouds { background: transparent url(https://www.script-tutorials.com/demos/360/images/clouds.png) repeat top center; z-index: 2; opacity: .4; animation: move-clouds-back 200s linear infinite; }

        @keyframes move-twink-back { from { background-position: 0 0; } to { background-position: -10000px 5000px; } }
        @keyframes move-clouds-back { from { background-position: 0 0; } to { background-position: 10000px 0; } }

        /* Custom UI Elements */
        .cyber-card {
            background: rgba(13, 22, 45, 0.5); backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1), inset 0 0 15px rgba(0, 255, 255, 0.05);
        }
        .cyber-button {
            border: 1px solid rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            transition: all 0.2s ease-in-out;
        }
        .cyber-button:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.7);
            background: rgba(0, 255, 255, 0.1);
        }
        .cyber-button:disabled {
            cursor: not-allowed;
            filter: grayscale(0.8);
        }
        main::-webkit-scrollbar { width: 8px; }
        main::-webkit-scrollbar-track { background: transparent; }
        main::-webkit-scrollbar-thumb { background-color: rgba(0, 255, 255, 0.3); border-radius: 4px; border: 1px solid rgba(0, 255, 255, 0.5); }
        .profile-avatar-upload { cursor: pointer; }

        /* New Sidebar Styles */
        #sidebar { z-index: 40; }
        .nav-link .nav-text { transition: opacity 0.2s ease-in-out; }
        #sidebar:not(:hover) .nav-text { opacity: 0; }
        .sidebar-scroll-area::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll-area::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(0, 255, 255, 0.3);
            border-radius: 3px;
            border: 1px solid rgba(0, 255, 255, 0.5);
        }
        .friend-options-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            z-index: 10;
        }
        .fa-crown.founder-title {
            color: #FFD700;
            text-shadow: 0 0 8px #FFD700, 0 0 12px #FFA500;
        }
        .fa-check-circle.verified-title {
            color: #38bdf8;
            text-shadow: 0 0 8px #38bdf8, 0 0 12px #0ea5e9;
        }
        #league-members-list::-webkit-scrollbar, .achievements-scroll-container::-webkit-scrollbar, #dashboard-events-container::-webkit-scrollbar { width: 6px; }
        #league-members-list::-webkit-scrollbar-track, .achievements-scroll-container::-webkit-scrollbar-track, #dashboard-events-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
        #league-members-list::-webkit-scrollbar-thumb, .achievements-scroll-container::-webkit-scrollbar-thumb, #dashboard-events-container::-webkit-scrollbar-thumb {
            background-color: rgba(0, 255, 255, 0.3);
            border-radius: 3px;
            border: 1px solid rgba(0, 255, 255, 0.5);
        }
        /* Achievement Rarity Colors */
        .rarity-common { color: #22c55e; /* green-500 */ }
        .rarity-rare { color: #f97316; /* orange-500 */ }
        .rarity-legendary { color: #facc15; /* yellow-400 */ text-shadow: 0 0 6px #facc15; }
        .rarity-mythic { color: #ef4444; /* red-500 */ text-shadow: 0 0 6px #ef4444; }

        /* --- NEW FEATURE STYLES --- */

        /* Event Glow */
        .event-glow {
            border: 1px solid rgba(192, 132, 252, 0.5); /* purple-300 */
            box-shadow: 0 0 15px rgba(192, 132, 252, 0.3), 0 0 8px rgba(192, 132, 252, 0.2) inset;
        }
        .event-text-glow {
            text-shadow: 0 0 6px rgba(192, 132, 252, 0.7), 0 0 10px rgba(192, 132, 252, 0.5);
        }

        /* Calendar Day Additions */
        .calendar-day-cell {
            position: relative;
            min-height: 70px; /* Ensure space for indicators */
        }
        .calendar-day-label {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.9rem;
            line-height: 1;
        }
        .calendar-event-indicator {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #c084fc; /* purple-400 */
            box-shadow: 0 0 6px #c084fc, 0 0 10px #c084fc;
        }

        /* Day Label Icons */
        .label-productive { color: #22c55e; } /* green-500 */
        .label-wasted { color: #ef4444; } /* red-500 */
        .label-holiday { color: #3b82f6; } /* blue-500 */

    </style>
</head>
<body class="text-gray-200 antialiased">
    <div class="background-container">
        <div class="stars"></div>
        <div class="twinkling"></div>
        <div class="clouds"></div>
    </div>

    <!-- Loading View -->
    <div id="loading-view" class="h-screen w-full flex items-center justify-center flex-col">
        <div class="w-16 h-16 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-2xl font-bold text-white font-orbitron text-glow">Signing In...</h2>
    </div>

    <!-- Login View --><div id="login-view" class="h-screen w-full flex items-center justify-center hidden">
        <div class="cyber-card p-8 rounded-lg w-full max-w-md">
            <img src="https://github.com/Tech4Aditya/StudyYPT/blob/main/StudyYPT.jpg?raw=true" alt="StudyYPT Logo" class="w-24 mx-auto mb-4">
            <h1 id="auth-title" class="text-3xl font-bold text-white text-glow font-orbitron mb-6 text-center">Login</h1>

            <form id="auth-form" class="space-y-4">
                <input type="text" id="username-input" placeholder="Choose a Username" class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500 hidden">
                <input type="email" id="email-input" placeholder="Email" required class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                <input type="password" id="password-input" placeholder="Password" required class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                <button type="submit" id="auth-submit-btn" class="cyber-button w-full bg-cyan-500/20 text-cyan-300 font-bold py-2 px-6 rounded-lg">Sign In</button>
            </form>

            <p id="auth-toggle-text" class="text-center mt-6 text-cyan-300 cursor-pointer">Don't have an account? Create one</p>
        </div>
    </div>

    <!-- Main App View --><div id="app-view" class="h-screen w-full flex bg-black/10 hidden">
        <!-- Icon Sidebar --><nav id="sidebar" class="group w-20 hover:w-56 transition-all duration-300 bg-black/30 backdrop-blur-lg border-r border-cyan-300/20 flex flex-col">
            <div class="p-4 flex items-center justify-center">
                <img src="https://github.com/Tech4Aditya/StudyYPT/blob/main/StudyYPT.jpg?raw=true" alt="StudyYPT Logo" class="w-12 h-12 rounded-full object-cover">
            </div>
            <div class="flex-1 overflow-y-auto sidebar-scroll-area py-4">
                <ul class="space-y-2 px-4">
                    <li><a href="#home" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20 bg-cyan-500/20"><i class="fas fa-compass w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Dashboard</span></a></li>
                    <li><a href="#calendar" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-calendar-alt w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Calendar</span></a></li>
                    <li><a href="#social" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-users w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Social</span></a></li>
                    <li><a href="#leagues" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-shield-halved w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Leagues</span></a></li>
                    <li><a href="#leaderboard" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-trophy w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Leaderboard</span></a></li>
                    <li><a href="#profile" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-user-astronaut w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Profile</span></a></li>
                    <li><a href="#inventory" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-box-archive w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Inventory</span></a></li>
                    <li><a href="#pass" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-gem w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Study Pass</span></a></li>
                    <li><a href="#shop" class="nav-link flex items-center p-3 rounded-lg text-gray-400 hover:text-cyan-300 hover:bg-cyan-500/20"><i class="fas fa-store w-6 text-2xl text-center"></i><span class="nav-text ml-4 font-semibold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Shop</span></a></li>
                </ul>
            </div>
             <div class="p-4 mt-auto">
                <div class="text-center text-xs text-cyan-300/50 font-semibold tracking-wider font-orbitron opacity-0 group-hover:opacity-100 transition-opacity">Made with ‚ù§Ô∏è<br>by aditya</div>
            </div>
        </nav>

        <!-- Main Area --><div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header --><header class="bg-black/10 backdrop-blur-lg border-b border-cyan-300/20 p-4 flex justify-between items-center z-10">
                <div><h2 id="page-title" class="text-3xl font-bold text-white text-glow font-orbitron">Dashboard</h2></div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-gray-900/50 px-3 py-1 rounded-full border border-gray-700"><i class="fas fa-database text-purple-400"></i><span id="header-user-sp" class="font-bold text-md font-orbitron">0</span></div>
                    <div class="flex items-center space-x-2 bg-gray-900/50 px-3 py-1 rounded-full border border-gray-700"><i class="fas fa-coins text-yellow-400"></i><span id="header-user-coins" class="font-bold text-md font-orbitron">0</span></div>
                    <div class="flex items-center space-x-3">
                        <div id="header-user-level" class="font-bold text-md font-orbitron bg-cyan-900/50 border-2 border-cyan-400/50 px-3 py-1 rounded-lg flex items-baseline gap-2">
                             <span class="text-cyan-300/80 tracking-widest text-xs">LEVEL</span>
                             <span id="level-text" class="text-white text-xl">1</span>
                        </div>
                        <div class="w-32 bg-gray-700 rounded-full h-2.5 border border-gray-600"><div id="header-xp-bar" class="bg-gradient-to-r from-cyan-400 to-blue-500 h-full rounded-full xp-bar-progress"></div></div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span id="header-user-name" class="font-semibold">User</span>
                        <img id="header-profile-pic" src="https://placehold.co/40x40/1f2937/ffffff?text=U" class="w-10 h-10 rounded-full border-2 border-cyan-400 object-cover">
                    </div>
                </div>
            </header>

            <!-- Main Content --><main class="flex-1 overflow-y-auto p-8">
                <div id="home" class="page">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-8">
                            <div class="cyber-card p-6 rounded-lg text-center">
                                <img id="dashboard-profile-pic" class="w-24 h-24 rounded-full mx-auto border-4 border-cyan-400/50 mb-4 object-cover">
                                <h3 id="dashboard-profile-name" class="text-2xl font-bold text-white font-orbitron"></h3>
                                <p id="dashboard-profile-league" class="text-cyan-300 font-semibold text-glow flex items-center justify-center"></p>

                                <div class="mt-4 grid grid-cols-2 gap-4">
                                    <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-cyan-900/50 to-gray-900/30">
                                        <p class="text-sm text-cyan-300 flex items-center justify-center gap-2"><i class="fas fa-calendar-day"></i> Today</p>
                                        <p id="dashboard-today-xp" class="text-xl font-bold font-orbitron text-white">0</p>
                                    </div>
                                    <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-pink-900/50 to-gray-900/30">
                                        <p class="text-sm text-pink-300 flex items-center justify-center gap-2"><i class="fas fa-moon"></i> Monthly</p>
                                        <p id="dashboard-monthly-xp" class="text-xl font-bold font-orbitron text-white">0</p>
                                    </div>
                                    <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-yellow-900/50 to-gray-900/30">
                                        <p class="text-sm text-yellow-300 flex items-center justify-center gap-2"><i class="fas fa-fire"></i> Total</p>
                                        <p id="dashboard-total-xp" class="text-xl font-bold font-orbitron text-white">0</p>
                                    </div>
                                    <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-purple-900/50 to-gray-900/30">
                                        <p class="text-sm text-purple-300 flex items-center justify-center gap-2"><i class="fas fa-trophy"></i> Rank</p>
                                        <p id="dashboard-rank" class="text-xl font-bold font-orbitron text-white">N/A</p>
                                    </div>
                                </div>

                                <div class="mt-4 col-span-2 cyber-card p-3 rounded-lg">
                                    <div class="flex justify-between items-center text-sm mb-1">
                                        <span class="font-bold text-cyan-300">Season <span id="dashboard-season-number">1</span> Pass</span>
                                        <span class="font-bold text-white">Tier <span id="dashboard-pass-tier">0</span></span>
                                    </div>
                                    <div class="w-full bg-gray-700/50 rounded-full h-2.5 border border-gray-600">
                                        <div id="dashboard-pass-progress" class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full xp-bar-progress" style="width: 0%;"></div>
                                    </div>
                                     <p id="dashboard-pass-xp-text" class="text-xs text-right text-gray-400 mt-1">0/0 XP to next tier</p>
                                </div>
                            </div>
                            <div class="quote-container cyber-card p-6 rounded-lg">
                                <p id="quote-text" class="text-lg italic text-gray-300"></p>
                                <p id="quote-author" class="text-right font-semibold text-cyan-300 mt-2"></p>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-8"> 
                             <div> 
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-3xl font-bold text-white font-orbitron">Today's Missions</h3>
                                    <button id="add-task-btn" class="cyber-button text-cyan-300 font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Add Task</button>
                                </div>
                                <div id="daily-tasks-container" class="space-y-4"></div>
                             </div>
                              <!-- MOVED: Upcoming Events -->
                             <div class="cyber-card p-6 rounded-lg">
                                <h3 class="text-2xl font-bold text-white font-orbitron mb-4 text-purple-300 event-text-glow">Upcoming Events</h3>
                                <div id="dashboard-events-container" class="space-y-3 max-h-64 overflow-y-auto">
                                    <!-- Events will be injected here by JS -->
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-4xl font-bold text-white font-orbitron">Mission Calendar</h2>
                        <h3 class="text-3xl font-bold text-white font-orbitron">Season <span id="calendar-season-number">1</span></h3>
                    </div>
                    <div class="cyber-card p-4 rounded-lg mb-6">
                        <div class="flex justify-between items-center px-2 mb-2">
                            <button id="prev-month-btn" class="text-cyan-300 text-2xl"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="month-year-header" class="text-2xl font-bold text-white font-orbitron"></h3>
                            <button id="next-month-btn" class="text-cyan-300 text-2xl"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center"></div>
                    </div>
                    <div id="calendar-task-controls" class="mb-4 hidden">
                         <h3 class="text-2xl font-bold text-white font-orbitron mb-4 text-center">Controls for <span id="selected-date-span"></span></h3>
                         <div class="flex justify-center gap-4">
                            <button id="calendar-add-task-btn" class="cyber-button text-cyan-300 font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Add Mission</button>
                            <button id="calendar-set-label-btn" class="cyber-button text-yellow-300 font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-tags"></i> Set Day Label</button>
                            <button id="calendar-create-event-btn" class="cyber-button text-purple-300 font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-star"></i> Create Event</button>
                         </div>
                    </div>
                    <div id="calendar-tasks-container" class="space-y-4"></div>
                </div>

                <div id="social" class="page hidden">
                    <h2 class="text-4xl font-bold text-white mb-6 font-orbitron">Social Hub</h2>
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-cyan-300 mb-4">Find Operatives</h3>
                        <input type="text" id="user-search-input" placeholder="Search by username..." class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                        <div id="user-search-results" class="mt-4 space-y-2"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-2xl font-bold text-cyan-300 mb-4">Friend Requests</h3>
                            <div id="friend-requests-container" class="space-y-3"></div>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-cyan-300 mb-4">Friends</h3>
                            <div id="friends-list-container" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="leagues" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-4xl font-bold text-white font-orbitron">League System</h2>
                        <h3 class="text-3xl font-bold text-white font-orbitron">Season <span id="leagues-season-number">1</span></h3>
                    </div>
                    <div id="leagues-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="leaderboard" class="page hidden">
                    <h2 class="text-4xl font-bold text-white mb-6 font-orbitron">Leaderboard</h2>
                    <div class="cyber-card rounded-lg overflow-hidden">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-cyan-500/10 text-cyan-300 font-orbitron">
                                    <th class="p-4">Rank</th>
                                    <th class="p-4" colspan="2">Operative</th>
                                    <th class="p-4">League</th>
                                    <th class="p-4">Pass Tier</th>
                                    <th class="p-4">Monthly XP</th>
                                    <th class="p-4">Level</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="profile" class="page hidden">
                     <h2 class="text-4xl font-bold text-white mb-6 font-orbitron">Operative Profile</h2>
                    <div class="cyber-card p-8 rounded-lg flex items-center space-x-8">
                        <div id="profile-avatar-container" class="relative group profile-avatar-upload">
                             <img id="profile-pic" src="https://placehold.co/128x128/01040a/00ffff?text=A" class="w-32 h-32 rounded-full border-4 border-cyan-400 object-cover">
                             <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full">
                                <i class="fas fa-camera text-3xl"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center">
                                 <input id="profile-name-input" class="bg-transparent text-4xl font-bold text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 font-orbitron" value="User">
                                 <span id="profile-title" class="ml-4 text-lg font-bold bg-gradient-to-r from-purple-400 to-pink-500 text-white px-3 py-1 rounded-full"></span>
                            </div>
                            <button id="update-profile-btn" class="cyber-button bg-green-500/20 border-green-400 text-green-300 font-bold py-2 px-4 rounded-lg mt-4">Save Changes</button>
                            <button id="sign-out-btn" class="cyber-button bg-red-500/20 border-red-400 text-red-300 font-bold py-2 px-4 rounded-lg ml-2 mt-4">Sign Out</button>
                            <p class="text-gray-400 mt-2">Member since: <span id="member-since"></span></p>
                        </div>
                    </div>
                    <h3 class="text-3xl font-bold mt-8 mb-4 text-white font-orbitron">Achievements</h3>
                    <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                     <h3 class="text-3xl font-bold mt-8 mb-4 text-white font-orbitron">Season History</h3>
                    <div id="season-history-container" class="space-y-4"></div>
                </div>

                 <div id="inventory" class="page hidden">
                    <h2 class="text-4xl font-bold text-white mb-6 font-orbitron">Operative Locker</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                             <h3 class="text-2xl font-bold text-cyan-300 mb-4">Unlocked Avatars</h3>
                             <div id="inventory-avatars-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                        </div>
                        <div>
                             <h3 class="text-2xl font-bold text-cyan-300 mb-4">Unlocked Titles</h3>
                             <div id="inventory-titles-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="pass" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-4xl font-bold text-white font-orbitron">Season Pass</h2>
                         <h3 class="text-3xl font-bold text-white font-orbitron">Season <span id="season-number">1</span></h3>
                    </div>
                    <p class="text-gray-400 mb-6">Gain monthly XP to unlock exclusive rewards. Resets monthly.</p>
                    <div class="w-full bg-black/50 rounded-full h-6 border border-cyan-300/30 mb-8 cyber-card p-1 relative">
                        <div id="pass-progress-bar" class="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 h-full rounded-full flex items-center justify-center text-sm font-bold text-white xp-bar-progress" style="width: 0%;"></div>
                        <div id="pass-progress-text" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-white"></div>
                    </div>
                    <div id="study-pass-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
                </div>
                <div id="shop" class="page hidden">
                     <h2 class="text-4xl font-bold text-white mb-6 font-orbitron">Supply Depot</h2>
                    <div id="shop-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="avatar-selection-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-8 w-full max-w-2xl mx-auto modal-content">
            <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Select Avatar</h2>
            <div id="avatar-grid" class="grid grid-cols-4 md:grid-cols-6 gap-4"></div>
             <div class="flex justify-end pt-6">
                <button id="close-avatar-modal-btn" class="bg-gray-600/50 hover:bg-gray-500/50 text-white font-bold py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <div id="user-profile-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-8 w-full max-w-xl mx-auto modal-content flex flex-col max-h-[90vh]">
            <div id="user-profile-content-wrapper" class="flex-grow overflow-y-auto pr-2 achievements-scroll-container">
                <!-- Content will be injected here -->
            </div>
            <div class="flex justify-end pt-6 flex-shrink-0">
                <button id="close-user-profile-modal-btn" class="bg-gray-600/50 hover:bg-gray-500/50 text-white font-bold py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <div id="first-time-setup-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-8 w-full max-w-md mx-auto modal-content">
            <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Welcome, Operative!</h2>
            <p class="text-gray-400 mb-6">Let's set up your display name.</p>
            <form id="first-time-setup-form" class="space-y-4">
                 <div>
                    <label for="setup-display-name" class="block text-sm font-medium text-cyan-300 mb-1">Choose your Display Name</label>
                    <input type="text" id="setup-display-name" required class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div class="flex justify-center pt-4">
                    <button type="submit" class="cyber-button bg-cyan-500/20 hover:bg-cyan-500/40 text-cyan-300 font-bold py-2 px-6 rounded-lg">Complete Setup</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-task-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-8 w-full max-w-md mx-auto modal-content">
            <h2 id="task-modal-title" class="text-2xl font-bold text-white mb-6 font-orbitron">Add New Mission</h2>
            <form id="add-task-form" class="space-y-4">
                 <input type="hidden" id="task-id">
                 <input type="hidden" id="task-date">
                 <div>
                    <label for="task-title" class="block text-sm font-medium text-cyan-300 mb-1">Mission Title</label>
                    <input type="text" id="task-title" required class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div>
                    <label for="task-duration" class="block text-sm font-medium text-cyan-300 mb-1">Duration (hours)</label>
                    <input type="number" id="task-duration" required min="0.5" max="8" step="0.5" class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div>
                    <label for="task-subject" class="block text-sm font-medium text-cyan-300 mb-1">Subject</label>
                    <select id="task-subject" class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                        <option>Basic Electronics</option>
                        <option>Software Dev</option>
                        <option>Maths</option>
                        <option>Physics</option>
                        <option>English</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div id="other-subject-container" class="hidden">
                    <label for="task-subject-other" class="block text-sm font-medium text-cyan-300 mb-1">Custom Subject</label>
                    <input type="text" id="task-subject-other" class="w-full bg-gray-900/50 border border-cyan-300/30 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-add-task-btn" class="bg-gray-600/50 hover:bg-gray-500/50 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                    <button type="submit" id="save-task-btn" class="cyber-button bg-cyan-500/20 hover:bg-cyan-500/40 text-cyan-300 font-bold py-2 px-6 rounded-lg">Add Mission</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Create Event Modal -->
    <div id="event-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-8 w-full max-w-md mx-auto modal-content event-glow">
            <h2 id="event-modal-title" class="text-2xl font-bold text-white mb-6 font-orbitron text-purple-300 event-text-glow">Create New Event</h2>
            <form id="event-form" class="space-y-4">
                 <input type="hidden" id="event-id">
                 <div>
                    <label for="event-title" class="block text-sm font-medium text-purple-300 mb-1">Event Title</label>
                    <input type="text" id="event-title" required class="w-full bg-gray-900/50 border border-purple-300/30 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label for="event-date" class="block text-sm font-medium text-purple-300 mb-1">Date</label>
                    <input type="date" id="event-date" required class="w-full bg-gray-900/50 border border-purple-300/30 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="event-time" class="block text-sm font-medium text-purple-300 mb-1">Time (Optional)</label>
                    <input type="time" id="event-time" class="w-full bg-gray-900/50 border border-purple-300/30 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="event-description" class="block text-sm font-medium text-purple-300 mb-1">Description (Optional)</label>
                    <textarea id="event-description" rows="3" class="w-full bg-gray-900/50 border border-purple-300/30 rounded-lg p-2.5 text-white focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-event-btn" class="bg-gray-600/50 hover:bg-gray-500/50 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                    <button type="submit" id="save-event-btn" class="cyber-button bg-purple-500/20 border-purple-400 text-purple-300 font-bold py-2 px-6 rounded-lg">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Day Label Modal -->
    <div id="day-label-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-8 w-full max-w-sm mx-auto modal-content">
            <h2 class="text-xl font-bold text-white mb-6 font-orbitron">Set Label for <span id="day-label-modal-date"></span></h2>
            <input type="hidden" id="day-label-date">
            <div class="grid grid-cols-1 gap-4">
                <button data-label="productive" class="day-label-btn cyber-button bg-green-500/20 border-green-400 text-green-300 font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-3 text-lg"><i class="fas fa-chart-line"></i> Productive</button>
                <button data-label="wasted" class="day-label-btn cyber-button bg-red-500/20 border-red-400 text-red-300 font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-3 text-lg"><i class="fas fa-couch"></i> Wasted Day</button>
                <button data-label="holiday" class="day-label-btn cyber-button bg-blue-500/20 border-blue-400 text-blue-300 font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-3 text-lg"><i class="fas fa-umbrella-beach"></i> Holiday</button>
                <button data-label="clear" class="day-label-btn cyber-button bg-gray-600/50 border-gray-500 text-white font-bold py-2 px-6 rounded-lg mt-4">Clear Label</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-8 w-full max-w-sm mx-auto modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-white mb-4 font-orbitron">Confirm Action</h2>
            <p id="confirm-modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel" class="bg-gray-600/50 hover:bg-gray-500/50 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-modal-confirm" class="cyber-button bg-red-500/20 border-red-400 text-red-300 font-bold py-2 px-6 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- League Members Modal -->
    <div id="league-members-modal" class="modal items-center justify-center">
        <div class="cyber-card rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto modal-content flex flex-col" style="max-height: 90vh;">
            <div class="flex items-center mb-4 flex-shrink-0">
                <h2 id="league-modal-title" class="text-2xl font-bold text-white font-orbitron flex items-center gap-3"></h2>
            </div>
            <div id="league-members-list" class="flex-grow overflow-y-auto pr-2 space-y-2">
                <!-- Members will be injected here -->
            </div>
             <div class="flex justify-end pt-6 flex-shrink-0">
                <button id="close-league-members-modal-btn" class="bg-gray-600/50 hover:bg-gray-500/50 text-white font-bold py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, query, updateDoc, arrayUnion, arrayRemove, where, addDoc, deleteDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyDv_NELQ4t4vDGsjjGYjjClt7tw1PXiNjg",
          authDomain: "studyypt-1fa01.firebaseapp.com",
          projectId: "studyypt-1fa01",
          storageBucket: "studyypt-1fa01.appspot.com",
          messagingSenderId: "366344997103",
          appId: "1:366344997103:web:2021dd4fab722caf2b331a",
          measurementId: "G-8L0G02Q5WE"
        };

        const appId = "studyypt-1fa01";

        // --- CONSTANTS ---
        const AVATAR_OPTIONS = [
            { id: 'default', url: 'https://placehold.co/128x128/01040a/00ffff?text=S' },
            { id: 'bronze', name: 'Bronze League', url: 'https://github.com/Tech4Aditya/StudyYPT/blob/main/bronze%20league.jpeg?raw=true' },
            { id: 'silver', name: 'Silver League', url: 'https://github.com/Tech4Aditya/StudyYPT/blob/main/silver%20league.jpeg?raw=true' },
            { id: 'gold', name: 'Gold League', url: 'https://github.com/Tech4Aditya/StudyYPT/blob/main/gold%20league.jpeg?raw=true' },
            { id: 'platinum', name: 'Platinum League', url: 'https://github.com/Tech4Aditya/StudyYPT/blob/main/platinum%20league.jpeg?raw=true' },
            { id: 'diamond', name: 'Diamond League', url: 'https://github.com/Tech4Aditya/StudyYPT/blob/main/diamond%20league.jpeg?raw=true' },
            { id: 'legend', name: 'Legend League', url: 'https://github.com/Tech4Aditya/StudyYPT/blob/main/legend%20league.jpeg?raw=true' },
            { id: 'avatar_rocket', url: 'https://placehold.co/128x128/9333ea/ffffff?text=üöÄ' },
            { id: 'avatar_brain', url: 'https://placehold.co/128x128/be123c/ffffff?text=üß†' },
            { id: 'avatar_atom', url: 'https://placehold.co/128x128/16a34a/ffffff?text=‚öõÔ∏è' },
            { id: 'avatar_book', url: 'https://placehold.co/128x128/ca8a04/ffffff?text=üìö' },
            { id: 'avatar_globe', url: 'https://placehold.co/128x128/0284c7/ffffff?text=üåç' },
            { id: 'viper', name: 'Viper', url: 'https://placehold.co/128x128/FFC300/000000?text=V' },
            { id: 'apex', name: 'Apex', url: 'https://placehold.co/128x128/DAF7A6/000000?text=A' },
            { id: 'rebel', name: 'Rebel', url: 'https://placehold.co/128x128/FF5733/000000?text=R' }
        ];
        const QUOTES = [ { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" }, { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" }, { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill"} ];
        const LEAGUES = [
            { id: 'bronze', name: "Bronze", minXP: 0, iconUrl: "https://github.com/Tech4Aditya/StudyYPT/blob/main/bronze%20league.jpeg?raw=true" },
            { id: 'silver', name: "Silver", minXP: 500, iconUrl: "https://github.com/Tech4Aditya/StudyYPT/blob/main/silver%20league.jpeg?raw=true" },
            { id: 'gold', name: "Gold", minXP: 1000, iconUrl: "https://github.com/Tech4Aditya/StudyYPT/blob/main/gold%20league.jpeg?raw=true" },
            { id: 'platinum', name: "Platinum", minXP: 3000, iconUrl: "https://github.com/Tech4Aditya/StudyYPT/blob/main/platinum%20league.jpeg?raw=true" },
            { id: 'diamond', name: "Diamond", minXP: 4000, iconUrl: "https://github.com/Tech4Aditya/StudyYPT/blob/main/diamond%20league.jpeg?raw=true" },
            { id: 'legend', name: "Legend", minXP: 5000, iconUrl: "https://github.com/Tech4Aditya/StudyYPT/blob/main/legend%20league.jpeg?raw=true" }
        ];
        const SHOP_ITEMS = [
            { id: 'viper', type: 'avatar', name: 'Viper Avatar', description: 'A sleek, serpentine avatar.', cost: 1000, currency: 'coins' },
            { id: 'apex', type: 'avatar', name: 'Apex Avatar', description: 'Reach the peak of style.', cost: 500, currency: 'sp' },
            { id: 'rebel', type: 'avatar', name: 'Rebel Avatar', description: 'For the operative who walks their own path.', cost: 2500, currency: 'coins' },
            { id: 'title_cyber_ninja', type: 'title', name: 'Title: Cyber-Ninja', description: 'A title for the swift and silent.', cost: 1000, currency: 'sp', icon: 'fa-user-ninja' },
            { id: 'title_quant', type: 'title', name: 'Title: The Quant', description: 'For the master of numbers.', cost: 1500, currency: 'sp', icon: 'fa-calculator' },
            { id: 'title_physicist', type: 'title', name: 'Title: The Physicist', description: 'For the explorer of reality.', cost: 3000, currency: 'coins', icon: 'fa-atom' },
            { id: 'title_founder', type: 'title', name: 'Title: Founder', description: 'For the original creator.', cost: 999999, currency: 'sp', icon: 'fa-crown', hidden: true },
            { id: 'title_verified', type: 'title', name: 'Title: Verified', description: 'Show off your official status.', cost: 1, currency: 'coins', icon: 'fa-check-circle' },
            { id: 'sp_pack_1', type: 'currency', name: '100 SP Pack', description: 'Get 100 SP for 2000 Coins.', cost: 2000, currency: 'coins' },
        ];
        const MOCK_ACHIEVEMENTS = [
            // Common
            { id: 'first_mission', name: 'First Mission', description: 'Complete your first task', icon: 'fa-shoe-prints', achieved: false, rarity: 'Common' },
            { id: 'task_master', name: 'Task Master', description: 'Complete 10 tasks', icon: 'fa-tasks', achieved: false, rarity: 'Common' },
            { id: 'first_friend', name: 'Social Operative', description: 'Add your first friend', icon: 'fa-user-friends', achieved: false, rarity: 'Common' },
            { id: 'first_title', name: 'Callsign Acquired', description: 'Equip a title for the first time', icon: 'fa-id-badge', achieved: false, rarity: 'Common' },
            { id: 'polymath', name: 'Polymath', description: 'Complete tasks in 3 different subjects', icon: 'fa-brain', achieved: false, rarity: 'Common' },
            // Rare
            { id: 'level_5', name: 'Ascendant', description: 'Reach Level 5', icon: 'fa-arrow-up', achieved: false, rarity: 'Rare' },
            { id: 'task_veteran', name: 'Mission Specialist', description: 'Complete 50 tasks', icon: 'fa-rocket', achieved: false, rarity: 'Rare' },
            { id: 'study_hours_50', name: 'Dedicated Learner', description: 'Log 50 hours of study', icon: 'fa-clock', achieved: false, rarity: 'Rare' },
            { id: 'silver_rank', name: 'Silver Tier', description: 'Reach Silver League', icon: 'fa-shield-alt', achieved: false, rarity: 'Rare' },
            // Legendary
            { id: 'legendary_scholar', name: 'Golden Scholar', description: 'Reach Gold League', icon: 'fa-graduation-cap', achieved: false, rarity: 'Legendary' },
            // Mythic
            { id: 'centurion', name: 'Centurion', description: 'Complete 100 tasks', icon: 'fa-shield-halved', achieved: false, rarity: 'Mythic' },
            { id: 'mythic_chronomancer', name: 'Mythic Chronomancer', description: 'Log 100 hours of study', icon: 'fa-hourglass-half', achieved: false, rarity: 'Mythic' },
            { id: 'level_50', name: 'Veteran', description: 'Reach Level 50', icon: 'fa-user-shield', achieved: false, rarity: 'Mythic' },
            { id: 'legend_rank', name: 'Legendary', description: 'Reach Legend League', icon: 'fa-star', achieved: false, rarity: 'Mythic' }
        ];
        const STUDY_PASS_REWARDS = [
            { xp: 1000, type: 'coins', value: 50 },
            { xp: 2000, type: 'sp', value: 30 },
            { xp: 3000, type: 'avatar', value: 'avatar_rocket' },
            { xp: 4000, type: 'coins', value: 200 },
            { xp: 5000, type: 'sp', value: 60 },
            { xp: 6000, type: 'avatar', value: 'avatar_brain' },
            { xp: 7000, type: 'coins', value: 400 },
            { xp: 8000, type: 'avatar', value: 'avatar_atom' },
            { xp: 9000, type: 'sp', value: 150 },
            { xp: 10000, type: 'avatar', value: 'avatar_globe' }
        ];

        // --- FIREBASE & STATE ---
        let app, auth, db;
        let userData;
        let isLoginMode = true;
        let unsubscribeUser;
        let currentCalendarDate = new Date();
        let allUsersCache = [];
        let incomingRequestsCache = [];
        let socialListeners = [];
        let allUsersListenerAttached = false;
        let botsData = [];
        let confirmCallback = null; // For the custom confirmation modal

        // --- BOT GENERATION ---
        function generateBotProfiles() {
            if (botsData.length > 0) return; // Only generate once
            const botNames = ["Alpha", "Bravo", "Charlie", "Delta", "Echo", "Foxtrot", "Golf", "Hotel", "India", "Juliett", "Kilo", "Lima", "Mike", "November", "Oscar", "Papa", "Quebec", "Romeo", "Sierra", "Tango", "Uniform", "Victor", "Whiskey", "X-ray", "Yankee", "Zulu"];
            const genericAvatars = AVATAR_OPTIONS.filter(a => !a.id.includes('league') && a.id !== 'default');
            const botTitles = SHOP_ITEMS.filter(item => item.type === 'title');

            for (let i = 0; i < 1000; i++) {
                const name = `${botNames[i % botNames.length]}-${Math.floor(100 + Math.random() * 900)}`;
                const randomAvatar = genericAvatars[Math.floor(Math.random() * genericAvatars.length)];
                let equippedTitle = null;
                if (Math.random() < 0.3) { // 30% chance of having a title
                    equippedTitle = botTitles[Math.floor(Math.random() * botTitles.length)].id;
                }

                botsData.push({
                    name: name,
                    uid: `bot_${i}`,
                    isBot: true,
                    level: Math.floor(1 + Math.random() * 50),
                    monthlyXP: Math.floor(Math.random() * 5000),
                    profilePicUrl: randomAvatar.url,
                    equippedTitle: equippedTitle
                });
            }
        }
        generateBotProfiles();

        // --- INITIALIZATION ---
        window.onload = () => {
             if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthObserver();
             } else {
                 document.getElementById('login-view').innerHTML = '<p class="text-red-500 text-center">Firebase config is missing or invalid. Please check the script.</p>';
             }
            setupEventListeners();
        };

        function setupAuthObserver() {
            onAuthStateChanged(auth, user => {
                if (unsubscribeUser) unsubscribeUser();
                socialListeners.forEach(unsub => unsub());
                socialListeners = [];

                if (user) {
                    if (!allUsersListenerAttached) {
                        fetchAllUsers();
                        allUsersListenerAttached = true;
                    }
                    loadUserData(user);
                } else {
                    document.getElementById('loading-view').classList.add('hidden');
                    document.getElementById('login-view').classList.remove('hidden');
                    document.getElementById('app-view').classList.add('hidden');
                    document.getElementById('first-time-setup-modal').style.display = 'none';
                    userData = null;
                    allUsersListenerAttached = false;
                }
            });
        }

        function fetchAllUsers() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/profiles`);
            const unsub = onSnapshot(usersRef, (snapshot) => {
                allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (userData) { // Only update UI if the main user data is also loaded
                    updateUI();
                }
            }, (error) => {
                console.error("Error fetching all users:", error);
                if (error.code === 'permission-denied') {
                    showConfirmModal("Could not load player data due to a permissions issue. Leaderboard and social features will be limited.", null, true);
                }
            });
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
            } catch (error) {
                console.error("Sign out failed:", error);
            }
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            const email = document.getElementById('email-input').value.trim();
            const username = document.getElementById('username-input').value.trim().toLowerCase();

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if (!username || !email || !password) throw new Error("Please fill in all fields.");
                    const usernameRef = doc(db, `usernames/${username}`);
                    const usernameSnap = await getDoc(usernameRef);
                    if (usernameSnap.exists()) throw new Error("Username is already taken.");

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await createInitialUserData(userCredential.user, username);
                }
            } catch (error) {
                console.error("Auth error:", error);
                showConfirmModal(`Authentication failed: ${error.message}`, null, true);
            }
        }

        function getSeasonInfo() {
            const startDate = new Date('2025-10-01T00:00:00Z');
            const now = new Date();
            const monthsDiff = (now.getFullYear() - startDate.getFullYear()) * 12 + (now.getMonth() - startDate.getMonth());
            const currentSeason = monthsDiff + 1;
            const currentSeasonId = `${now.getFullYear()}-${now.getMonth()}`;
            return { number: currentSeason, id: currentSeasonId };
        }

        // --- PERSISTENCE (Firestore) ---
        async function loadUserData(user) {
            const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
            unsubscribeUser = onSnapshot(userRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    const username = user.email ? user.email.split('@')[0] : `operative${Date.now()}`;
                    await createInitialUserData(user, username);
                    return;
                }

                userData = docSnap.data();
                let needsSave = false;

                // --- BACKWARDS COMPATIBILITY & DATA INIT ---
                if (!userData.achievements) userData.achievements = [];
                const existingAchievementIds = new Set(userData.achievements.map(a => a.id));
                const newAchievements = MOCK_ACHIEVEMENTS.filter(a => !existingAchievementIds.has(a.id));
                if (newAchievements.length > 0) {
                    userData.achievements.push(...newAchievements);
                    needsSave = true;
                }

                if (!userData.tasks) {
                    userData.tasks = {};
                    needsSave = true;
                }

                // NEW: Initialize events (ensure it's an array)
                if (!Array.isArray(userData.events)) { // More robust check
                    userData.events = [];
                    needsSave = true;
                }
                // NEW: Initialize dayLabels
                if (!userData.dayLabels) { // Objects don't need Array.isArray
                    userData.dayLabels = {};
                    needsSave = true;
                }


                if (typeof userData.totalXP !== 'number') {
                    let reconstructedTotalXP = 0;
                    if (userData.seasonHistory) {
                        Object.values(userData.seasonHistory).forEach(season => {
                            reconstructedTotalXP += season.xp || 0;
                        });
                    }
                    reconstructedTotalXP += userData.monthlyXP || 0;
                    userData.totalXP = reconstructedTotalXP;
                    needsSave = true;
                }

                if (typeof userData.totalHoursStudied !== 'number') {
                    userData.totalHoursStudied = 0;
                     Object.values(userData.tasks).flat().filter(t => t.status !== 'pending').forEach(task => {
                        userData.totalHoursStudied += task.duration;
                    });
                    needsSave = true;
                }


                userData.tasksCompletedToday = userData.tasksCompletedToday || 0;
                userData.seasonHistory = userData.seasonHistory || {};

                const today = new Date().toDateString();
                const seasonInfo = getSeasonInfo();

                if (!userData.lastLoginDate || new Date(userData.lastLoginDate).toDateString() !== today) {
                    userData.todayXP = 0;
                    userData.tasksCompletedToday = 0;
                    userData.lastLoginDate = today;
                    needsSave = true;
                }

                if (userData.lastSeasonId && userData.lastSeasonId !== seasonInfo.id) {
                    const lastSeasonXP = userData.monthlyXP || 0;
                    const lastSeasonLeague = LEAGUES.slice().reverse().find(l => lastSeasonXP >= l.minXP) || LEAGUES[0];
                    userData.seasonHistory[userData.lastSeasonId] = {
                        xp: lastSeasonXP,
                        league: lastSeasonLeague.name
                    };

                    userData.monthlyXP = 0;
                    userData.studyPassProgress = { claimedTiers: [] };
                    needsSave = true;
                }

                userData.lastSeasonId = seasonInfo.id;
                if(needsSave) await saveUserData();

                if (!userData.setupComplete) {
                    document.getElementById('loading-view').classList.add('hidden');
                    document.getElementById('setup-display-name').value = userData.displayName;
                    document.getElementById('first-time-setup-modal').style.display = 'flex';
                } else {
                    document.getElementById('loading-view').classList.add('hidden');
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('app-view').classList.remove('hidden');
                    document.getElementById('first-time-setup-modal').style.display = 'none';
                    updateUI();
                }
            }, (error) => {
                console.error("Snapshot error:", error);
            });
        }

        async function handleFirstTimeSetup(e) {
            e.preventDefault();
            const displayName = document.getElementById('setup-display-name').value;
            if (!displayName.trim()) {
                console.error("Display name is empty.");
                return;
            }

            try {
                userData.displayName = displayName;
                userData.profilePicUrl = `https://placehold.co/128x128/01040a/00ffff?text=${displayName.charAt(0).toUpperCase()}`;
                userData.setupComplete = true;
                await saveUserData();
            } catch (error) {
                console.error(`Setup failed: ${error.message}`);
            }
        }


        async function createInitialUserData(user, username) {
            const today = new Date().toDateString();
            const seasonInfo = getSeasonInfo();
            const newUserData = {
                uid: user.uid,
                displayName: username,
                username: username,
                email: user.email,
                profilePicUrl: AVATAR_OPTIONS.find(a => a.id === 'default').url,
                unlockedAvatars: ['default'],
                unlockedTitles: [],
                equippedTitle: null,
                setupComplete: false,
                createdAt: new Date().toISOString(),
                level: 1, xp: 0, coins: 50, sp: 5, monthlyXP: 0,
                totalXP: 0,
                totalHoursStudied: 0,
                tasks: {},
                events: [], // NEW - Initialized as empty array
                dayLabels: {}, // NEW
                purchasedItems: [], todayXP: 0, tasksCompletedToday: 0, achievements: MOCK_ACHIEVEMENTS,
                studyPassProgress: { claimedTiers: [] },
                friends: [],
                seasonHistory: {},
                lastLoginDate: today,
                lastQuoteDate: today,
                lastSeasonId: seasonInfo.id
            };
            const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
            await setDoc(userRef, newUserData);
            const usernameRef = doc(db, `usernames/${username}`);
            await setDoc(usernameRef, { email: user.email, uid: user.uid });
            await updatePublicProfile(newUserData);
        }

        async function saveUserData() {
            if (!auth.currentUser || !userData) return;
            // Ensure events is an array before saving
            if (!Array.isArray(userData.events)) {
                console.warn("Attempted to save userData.events but it wasn't an array. Resetting to [].");
                userData.events = [];
            }
            try {
                const userRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                await setDoc(userRef, userData, { merge: true });
                await updatePublicProfile(userData);
            } catch (error) {
                console.error("Error saving user data:", error);
            }
        }

        async function updatePublicProfile(data) {
             if (!data.uid) return;
             const publicRef = doc(db, `artifacts/${appId}/public/data/profiles/${data.uid}`);
             const publicData = {
                displayName: data.displayName,
                profilePicUrl: data.profilePicUrl,
                monthlyXP: data.monthlyXP,
                level: data.level,
                uid: data.uid,
                totalXP: data.totalXP || 0,
                achievements: data.achievements,
                equippedTitle: data.equippedTitle,
                seasonHistory: data.seasonHistory || {}
             };
             await setDoc(publicRef, publicData, { merge: true });
         }

        // --- DATA HANDLING ---
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function addTask(title, duration, subject, dateString) {
            const targetDate = dateString || getTodayDateString();
            if(!userData.tasks[targetDate]) {
                userData.tasks[targetDate] = [];
            }

            const hours = parseFloat(duration); if (isNaN(hours) || hours <= 0) return;
            let xp = (hours === 1) ? 30 : 30 + (hours - 1) * 20;
            const coins = Math.ceil(xp / 2);
            const sp = Math.ceil(xp / 10);
            userData.tasks[targetDate].push({ id: `task_${Date.now()}`, title, duration: hours, subject, xp, coins, sp, status: 'pending' });
            saveUserData();
        }

        function updateTask(taskId, taskDate, updates) {
            if (!userData.tasks[taskDate]) return;
            const taskIndex = userData.tasks[taskDate].findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                const task = userData.tasks[taskDate][taskIndex];
                task.title = updates.title;
                task.duration = parseFloat(updates.duration);
                task.subject = updates.subject;

                let xp = (task.duration === 1) ? 30 : 30 + (task.duration - 1) * 20;
                task.xp = xp;
                task.coins = Math.ceil(xp / 2);
                task.sp = Math.ceil(xp / 10);

                saveUserData();
            }
        }

        function deleteTask(taskId, taskDate) {
            if (!userData.tasks[taskDate]) return;
            const taskIndex = userData.tasks[taskDate].findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                userData.tasks[taskDate].splice(taskIndex, 1);
                saveUserData();
            }
        }

        async function updatePublicActivity(duration) {
            if(!auth.currentUser) return;
            const today = getTodayDateString();
            const activityRef = doc(db, `artifacts/${appId}/public/data/activity/${auth.currentUser.uid}/logs/${today}`);
            try {
                await setDoc(activityRef, {
                    tasksCompleted: increment(1),
                    hoursStudied: increment(duration)
                }, { merge: true });
            } catch (e) {
                console.error("Error updating public activity:", e);
            }
        }

        function completeTask(taskId, taskDate, completionStatus) {
            const today = getTodayDateString();
            if (taskDate !== today) {
                console.error("Attempted to complete a task not for today.");
                return;
            }

            if (userData.tasksCompletedToday >= 20) {
                showConfirmModal("You have reached the daily limit of 20 completed tasks. Come back tomorrow!", null, true);
                return;
            }

            if (!userData.tasks[taskDate]) return;
            const task = userData.tasks[taskDate].find(t => t.id === taskId);

            if (!task || task.status !== 'pending') return;

            let xpEarned = task.xp;
            let coinsEarned = task.coins;
            let spEarned = task.sp;

            if (completionStatus === 'partial') {
                xpEarned = Math.floor(task.xp / 2);
                coinsEarned = Math.floor(task.coins / 2);
                spEarned = Math.floor(task.sp / 2);
                task.status = 'partial';
            } else { // 'completed'
                task.status = 'completed';
            }

            userData.coins += coinsEarned;
            userData.sp += spEarned;
            userData.monthlyXP += xpEarned;
            userData.totalXP = (userData.totalXP || 0) + xpEarned;
            userData.todayXP += xpEarned;
            userData.totalHoursStudied = (userData.totalHoursStudied || 0) + task.duration;

            const xpForNextLevel = Math.floor(Math.pow(userData.level, 1.2) * 100);
            if (userData.xp + xpEarned >= xpForNextLevel && userData.level < 100000) {
                userData.level++;
                userData.xp = (userData.xp + xpEarned) - xpForNextLevel;
            } else {
                userData.xp += xpEarned;
            }

            // Check all achievements after a task is completed
            checkAllAchievements();

            userData.tasksCompletedToday++;

            updatePublicActivity(task.duration);
            saveUserData();
        }

        function checkAllAchievements() {
            const completedTasks = Object.values(userData.tasks).flat().filter(t => t.status === 'completed' || t.status === 'partial');
            const totalCompleted = completedTasks.length;

            // Task count achievements
            if (totalCompleted >= 1) checkAchievements('first_mission');
            if (totalCompleted >= 10) checkAchievements('task_master');
            if (totalCompleted >= 50) checkAchievements('task_veteran');
            if (totalCompleted >= 100) checkAchievements('centurion');

            // Study hours achievements
            if (userData.totalHoursStudied >= 50) checkAchievements('study_hours_50');
            if (userData.totalHoursStudied >= 100) checkAchievements('mythic_chronomancer');

            // Level achievements
            if (userData.level >= 5) checkAchievements('level_5');
            if (userData.level >= 50) checkAchievements('level_50');

            // League achievements
            const currentLeague = LEAGUES.slice().reverse().find(l => userData.monthlyXP >= l.minXP) || LEAGUES[0];
            if (currentLeague.id === 'silver') checkAchievements('silver_rank');
            if (currentLeague.id === 'gold') checkAchievements('legendary_scholar');
            if (currentLeague.id === 'legend') checkAchievements('legend_rank');

            // Subject achievement
            const uniqueSubjects = new Set(completedTasks.map(t => t.subject));
            if (uniqueSubjects.size >= 3) {
                checkAchievements('polymath');
            }
        }

        function checkAchievements(achievementId) {
            const achievement = userData.achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.achieved) {
                achievement.achieved = true;
                showConfirmModal(`Achievement Unlocked: ${achievement.name}!`, null, true);
            }
        }

        function claimStudyPassReward(tierIndex) {
            if (!userData) return;
            const tier = STUDY_PASS_REWARDS[tierIndex];
            if (!tier) return;
            if (userData.monthlyXP < tier.xp) {
                return;
            }
            if (userData.studyPassProgress.claimedTiers.includes(tierIndex)) {
                return;
            }

            let rewardMessage = "";
            if (tier.type === 'coins') {
                userData.coins += tier.value;
                rewardMessage = `${tier.value} Coins`;
            } else if (tier.type === 'sp') {
                userData.sp += tier.value;
                 rewardMessage = `${tier.value} SP`;
            } else if (tier.type === 'avatar') {
                if (!userData.unlockedAvatars.includes(tier.value)) {
                    userData.unlockedAvatars.push(tier.value);
                }
                rewardMessage = "New Avatar";
            }

            userData.studyPassProgress.claimedTiers.push(tierIndex);
            saveUserData();
            showConfirmModal(`Reward claimed: ${rewardMessage}!`, null, true);
        }

        function purchaseShopItem(itemId) {
            const item = SHOP_ITEMS.find(i => i.id === itemId);
            if (!item) return;

            if (item.currency === 'coins' && userData.coins < item.cost) {
                showConfirmModal("Not enough coins!", null, true); return;
            }
            if (item.currency === 'sp' && userData.sp < item.cost) {
                showConfirmModal("Not enough Study Points!", null, true); return;
            }
            if (item.currency === 'coins') userData.coins -= item.cost;
            if (item.currency === 'sp') userData.sp -= item.cost;

            let purchasedMessage = `Purchased ${item.name}!`;
            if (item.type === 'avatar') {
                if (!userData.unlockedAvatars.includes(item.id)) {
                    userData.unlockedAvatars.push(item.id);
                }
            } else if (item.type === 'title') {
                 if (!userData.unlockedTitles.includes(item.id)) {
                    userData.unlockedTitles.push(item.id);
                }
            } else if (item.type === 'currency') {
                userData.sp += 100; // Hardcoded for sp_pack_1
            }

            showConfirmModal(purchasedMessage, null, true);
            saveUserData();
        }

        function checkAndUnlockLeagueAvatars() {
            if (!userData) return;
            let changed = false;
            LEAGUES.forEach(league => {
                if (userData.monthlyXP >= league.minXP) {
                    if (!userData.unlockedAvatars.includes(league.id)) {
                        userData.unlockedAvatars.push(league.id);
                        changed = true;
                    }
                }
            });
            if (changed) {
                saveUserData();
            }
        }


        // --- UI RENDERING ---
        function updateUI() {
            if (!userData) return;

            checkAndUnlockLeagueAvatars();

            const currentLeague = LEAGUES.slice().reverse().find(l => userData.monthlyXP >= l.minXP) || LEAGUES[0];
            const pfpUrl = userData.profilePicUrl || `https://placehold.co/128x128/01040a/00ffff?text=${(userData.displayName || '?').charAt(0).toUpperCase()}`;
            const seasonInfo = getSeasonInfo();

            document.getElementById('header-user-name').textContent = userData.displayName || 'Operative';
            document.getElementById('dashboard-profile-name').textContent = userData.displayName || 'Operative';
            document.getElementById('header-user-coins').textContent = userData.coins;
            document.getElementById('header-user-sp').textContent = userData.sp;
            document.getElementById('level-text').textContent = userData.level;

            document.getElementById('dashboard-today-xp').textContent = userData.todayXP || 0;
            document.getElementById('dashboard-monthly-xp').textContent = userData.monthlyXP || 0;
            document.getElementById('dashboard-total-xp').textContent = userData.totalXP || 0;

            const xpForNextLevel = Math.floor(Math.pow(userData.level, 1.2) * 100);
            const percentage = xpForNextLevel > 0 ? (userData.xp / xpForNextLevel) * 100 : 0;
            document.getElementById('header-xp-bar').style.width = `${Math.min(100, percentage)}%`;


            ['header-profile-pic', 'dashboard-profile-pic', 'profile-pic'].forEach(id => document.getElementById(id).src = pfpUrl);

            document.getElementById('dashboard-profile-league').innerHTML = `<img src="${currentLeague.iconUrl}" class="w-6 h-6 mr-2 inline-block rounded-full"> ${currentLeague.name}`;
            document.getElementById('member-since').textContent = new Date(userData.createdAt).toLocaleDateString();
            document.getElementById('profile-name-input').value = userData.displayName;

            const profileTitleEl = document.getElementById('profile-title');
            const equippedTitle = SHOP_ITEMS.find(item => item.id === userData.equippedTitle && item.type === 'title');
            let titleIconHTML = '';
            if(equippedTitle){
                 let iconClass = 'text-cyan-300';
                 if(equippedTitle.id === 'title_founder') iconClass = 'founder-title';
                 if(equippedTitle.id === 'title_verified') iconClass = 'verified-title';
                 titleIconHTML = `<i class="fas ${equippedTitle.icon} ${iconClass} ml-2"></i>`;
            }

            document.getElementById('header-user-name').innerHTML = `${userData.displayName || 'Operative'}${titleIconHTML}`;
            document.getElementById('dashboard-profile-name').innerHTML = `${userData.displayName || 'Operative'}${titleIconHTML}`;

            if (equippedTitle) {
                profileTitleEl.textContent = equippedTitle.name.replace('Title: ', '');
                profileTitleEl.style.display = 'inline-block';
            } else {
                profileTitleEl.style.display = 'none';
            }

            document.getElementById('dashboard-season-number').textContent = seasonInfo.number;
            const unlockedTiersCount = STUDY_PASS_REWARDS.filter(tier => userData.monthlyXP >= tier.xp).length;
            document.getElementById('dashboard-pass-tier').textContent = unlockedTiersCount;

            let passProgressPercent = 100;
            let passXpText = "Max Tier Reached";

            if (unlockedTiersCount < STUDY_PASS_REWARDS.length) {
                const currentTierXP = unlockedTiersCount > 0 ? STUDY_PASS_REWARDS[unlockedTiersCount - 1].xp : 0;
                const nextTierXP = STUDY_PASS_REWARDS[unlockedTiersCount].xp;
                const xpTowardsNext = userData.monthlyXP - currentTierXP;
                const xpNeededForNext = nextTierXP - currentTierXP;
                passProgressPercent = (xpTowardsNext / xpNeededForNext) * 100;
                passXpText = `${xpTowardsNext} / ${xpNeededForNext} XP to next tier`;
            }

            document.getElementById('dashboard-pass-progress').style.width = `${passProgressPercent}%`;
            document.getElementById('dashboard-pass-xp-text').textContent = passXpText;

            const activePage = document.querySelector('.page:not(.hidden)');
            if (activePage) {
                switch(activePage.id) {
                    case 'home':
                        renderTasks();
                        renderDashboardEvents(); // NEW
                        break;
                    case 'calendar': renderCalendar(); break;
                    case 'leagues': renderLeaguesPage(); break;
                    case 'leaderboard': renderLeaderboard(); break;
                    case 'profile': renderAchievements(); renderSeasonHistory(); break;
                    case 'inventory': renderInventoryPage(); break;
                    case 'pass': renderStudyPass(); break;
                    case 'shop': renderShop(); break;
                }
            } else {
                renderTasks();
                renderDashboardEvents(); // NEW
            }

            updateDailyQuote();
            renderLeaderboard();
        }

        function renderTasks(dateString) {
            const today = getTodayDateString();
            const targetDate = dateString || today;
            const container = dateString ? document.getElementById('calendar-tasks-container') : document.getElementById('daily-tasks-container');

            if (!container || !userData || !userData.tasks) return;
            const tasksForDay = userData.tasks[targetDate] || [];

            container.innerHTML = tasksForDay.length === 0 ? `<div class="text-center text-gray-400 p-8 cyber-card rounded-lg">No missions for this day.</div>` : '';
            tasksForDay.forEach(task => {
                const el = document.createElement('div');
                el.className = `cyber-card p-4 rounded-lg flex items-center justify-between transition-all duration-300 ${task.status !== 'pending' ? 'opacity-40' : 'hover:border-cyan-400'}`;

                const isCompletable = task.status === 'pending' && targetDate === today;
                const isEditable = task.status === 'pending';
                let actionButtonsHTML = '';

                if (isCompletable) {
                    actionButtonsHTML = `
                        <button class="task-edit-btn cyber-button text-blue-300 p-2 rounded-lg text-sm" data-task-id="${task.id}" data-task-date="${targetDate}" title="Edit"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
                        <button class="task-partial-btn cyber-button text-yellow-300 p-2 rounded-lg text-sm" data-task-id="${task.id}" data-task-date="${targetDate}" title="Partially Complete"><i class="fas fa-adjust pointer-events-none"></i></button>
                        <button class="task-full-btn cyber-button text-green-300 p-2 rounded-lg text-sm" data-task-id="${task.id}" data-task-date="${targetDate}" title="Fully Complete"><i class="fas fa-check pointer-events-none"></i></button>
                        <button class="task-delete-btn cyber-button text-red-300 p-2 rounded-lg text-sm" data-task-id="${task.id}" data-task-date="${targetDate}" title="Delete"><i class="fas fa-trash pointer-events-none"></i></button>
                    `;
                } else if (isEditable) {
                    actionButtonsHTML = `
                        <button class="task-edit-btn cyber-button text-blue-300 p-2 rounded-lg text-sm" data-task-id="${task.id}" data-task-date="${targetDate}" title="Edit"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
                        <button class="task-delete-btn cyber-button text-red-300 p-2 rounded-lg text-sm" data-task-id="${task.id}" data-task-date="${targetDate}" title="Delete"><i class="fas fa-trash pointer-events-none"></i></button>
                    `;
                } else {
                    let statusText, statusIcon, statusColor;

                    switch(task.status) {
                        case 'partial':
                            statusText = 'Partial';
                            statusIcon = 'fa-adjust';
                            statusColor = 'text-yellow-400';
                            break;
                        case 'completed':
                            statusText = 'Completed';
                            statusIcon = 'fa-check-circle';
                            statusColor = 'text-green-400';
                            break;
                        default:
                            statusText = 'Status Unknown';
                            if(typeof task.status === 'string' && task.status) {
                                statusText = task.status.charAt(0).toUpperCase() + task.status.slice(1);
                            }
                            statusIcon = 'fa-question-circle';
                            statusColor = 'text-gray-400';
                            break;
                    }
                    actionButtonsHTML = `<span class="${statusColor} font-bold"><i class="fas ${statusIcon} mr-2"></i>${statusText}</span>`;
                }

                el.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-lg text-white truncate">${task.title || 'Untitled Mission'}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs bg-cyan-500/20 text-cyan-300 px-2 py-0.5 rounded-full">${task.subject || 'General'}</span>
                            <span class="text-sm text-gray-400">${task.duration}hr mission</span>
                        </div>
                    </div>
                    <div class="text-right font-orbitron mx-4 flex-shrink-0">
                        <p class="font-semibold text-cyan-300">+${task.xp} XP</p>
                        <p class="font-semibold text-yellow-400">+${task.coins} C / <span class="text-purple-400">+${task.sp} SP</span></p>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">${actionButtonsHTML}</div>
                `;
                container.appendChild(el);
            });
        }

        // NEW: Render Dashboard Events (with Array check)
        function renderDashboardEvents() {
            const container = document.getElementById('dashboard-events-container');
            // FIX: Add check to ensure userData.events is an array
            if (!container || !userData || !Array.isArray(userData.events)) {
                 if(container) container.innerHTML = '<p class="text-gray-400 text-center">No upcoming events or events data is invalid.</p>';
                 if (userData && !Array.isArray(userData.events)) {
                     console.error("userData.events is not an array in renderDashboardEvents. Value:", userData.events);
                     // Optionally try to fix it here if appropriate, e.g., userData.events = []; saveUserData();
                 }
                return;
            }

            const now = new Date();
            const todayStr = getTodayDateString();
            now.setHours(0, 0, 0, 0); // Set to start of today

            const upcomingEvents = userData.events
                .map(event => { // This line caused the error if userData.events is not an array
                    const eventDate = new Date(event.date + 'T00:00:00');
                    return { ...event, eventDate };
                })
                .filter(event => event.eventDate >= now)
                .sort((a, b) => a.eventDate - b.eventDate);

            if (upcomingEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center">No upcoming events.</p>';
                return;
            }

            container.innerHTML = '';
            upcomingEvents.slice(0, 5).forEach(event => { // Show top 5
                const eventEl = document.createElement('div');
                eventEl.className = 'cyber-card p-3 rounded-lg event-glow';

                const eventDateTime = new Date(`${event.date}T${event.time || '00:00:00'}`);
                const nowMs = Date.now();
                const eventMs = eventDateTime.getTime();
                const diffMs = eventMs - nowMs;

                let timerHTML = '';
                if (diffMs > 0) {
                    const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    if (days > 0) {
                        timerHTML = `<span class="font-semibold text-purple-300">${days}d ${hours}h left</span>`;
                    } else if (hours > 0) {
                        timerHTML = `<span class="font-semibold text-orange-400">${hours}h ${minutes}m left</span>`;
                    } else if (minutes > 0) {
                        timerHTML = `<span class="font-semibold text-red-400">${minutes}m left</span>`;
                    } else {
                        timerHTML = `<span class="font-semibold text-red-500">Starting now</span>`;
                    }
                } else if (event.date === todayStr) {
                    timerHTML = `<span class="font-semibold text-red-500">Today</span>`;
                } else {
                    timerHTML = `<span class="font-semibold text-gray-400">Past</span>`;
                }


                eventEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-md text-white">${event.title}</h4>
                            <p class="text-sm text-gray-300">${new Date(event.date + 'T00:00:00').toLocaleDateString()} ${event.time ? '@ ' + event.time : ''}</p>
                            <p class="text-xs text-gray-400 mt-1">${timerHTML}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="event-edit-btn cyber-button text-blue-300 p-2 text-xs rounded-lg" data-event-id="${event.id}" title="Edit"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
                            <button class="event-delete-btn cyber-button text-red-300 p-2 text-xs rounded-lg" data-event-id="${event.id}" title="Delete"><i class="fas fa-trash pointer-events-none"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(eventEl);
            });
        }


        function renderLeaderboard() {
            try {
                const container = document.getElementById('leaderboard-body');
                const rankEl = document.getElementById('dashboard-rank');
                if (!container || !allUsersCache) return;

                const usersFromDB = [...allUsersCache];

                botsData.forEach((bot, index) => {
                    const lastUpdate = localStorage.getItem(`bot_update_${bot.name}`);
                    const today = new Date().toDateString();
                    if (lastUpdate !== today) {
                        let dailyGain;
                        if (index < 500) {
                            dailyGain = Math.floor(Math.random() * (120 - 50 + 1)) + 50;
                        } else {
                            dailyGain = Math.floor(Math.random() * (200 - 120 + 1)) + 120;
                        }
                        bot.monthlyXP += dailyGain;
                        bot.monthlyXP = Math.min(bot.monthlyXP, 5000);
                        if (Math.random() > 0.8) bot.level += 1;
                        localStorage.setItem(`bot_update_${bot.name}`, today);
                    }
                });

                const allPlayers = [...usersFromDB, ...botsData];
                allPlayers.sort((a, b) => (b.monthlyXP || 0) - (a.monthlyXP || 0));

                if (auth.currentUser) {
                    const userRank = allPlayers.findIndex(p => p.uid === auth.currentUser.uid || p.id === auth.currentUser.uid) + 1;
                    if(rankEl) {
                        rankEl.textContent = userRank > 0 ? `#${userRank}`: 'N/A';
                    }
                } else if(rankEl) {
                    rankEl.textContent = 'N/A';
                }

                container.innerHTML = '';
                allPlayers.slice(0, 100).forEach((player, index) => {
                    if (!player.displayName && !player.name) return;

                    const playerLeague = LEAGUES.slice().reverse().find(l => (player.monthlyXP || 0) >= l.minXP) || LEAGUES[0];
                    const displayTier = STUDY_PASS_REWARDS.filter(tier => (player.monthlyXP || 0) >= tier.xp).length;
                    let titleIconHTML = '';
                    if(player.isBot){
                         titleIconHTML = `<i class="fas fa-microchip text-gray-500 ml-2"></i>`;
                    } else {
                        const equippedTitle = SHOP_ITEMS.find(item => item.id === player.equippedTitle && item.type === 'title');
                        if (equippedTitle) {
                            titleIconHTML = `<i class="fas ${equippedTitle.icon} ${equippedTitle.id === 'title_founder' ? 'founder-title' : 'text-cyan-400'} ml-2"></i>`;
                        }
                    }

                    const row = document.createElement('tr');
                    const isCurrentUser = auth.currentUser && (player.uid === auth.currentUser.uid || player.id === auth.currentUser.uid);
                    row.className = `border-b border-cyan-300/10 ${isCurrentUser ? 'bg-cyan-500/20 text-white' : ''}`;
                    row.innerHTML = `
                        <td class="p-4 font-bold text-lg font-orbitron">${index + 1}</td>
                        <td class="p-4"><img src="${player.profilePicUrl || ''}" class="w-10 h-10 rounded-full object-cover"></td>
                        <td class="p-4 font-semibold"><div class="flex items-center">${player.displayName || player.name} ${titleIconHTML}</div></td>
                        <td class="p-4"><div class="flex items-center"><img src="${playerLeague.iconUrl}" class="w-6 h-6 mr-2 rounded-full"><span>${playerLeague.name}</span></div></td>
                        <td class="p-4 font-orbitron">${displayTier}</td>
                        <td class="p-4 text-cyan-300 font-orbitron">${player.monthlyXP || 0}</td>
                        <td class="p-4 font-orbitron">${player.level || 1}</td>`;
                    container.appendChild(row);
                });
            } catch (error) {
                console.error("Failed to render leaderboard:", error);
            }
        }

        function renderLeaguesPage() {
            const container = document.getElementById('leagues-container');
            if (!container) return;
            if (!userData || !allUsersCache || allUsersCache.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 p-8 cyber-card rounded-lg col-span-full">Loading league data...</div>';
                return;
            }

            const allPlayers = [...allUsersCache, ...botsData];

            container.innerHTML = '';
            LEAGUES.forEach((league, index) => {
                const nextLeague = LEAGUES[index + 1];
                const playersInLeague = allPlayers.filter(p => {
                    const xp = p.monthlyXP || 0;
                    if(nextLeague) {
                        return xp >= league.minXP && xp < nextLeague.minXP;
                    }
                    return xp >= league.minXP;
                }).length;

                const isCurrentLeague = userData.monthlyXP >= league.minXP && (!nextLeague || userData.monthlyXP < nextLeague.minXP);
                let progressHTML = '';
                if(isCurrentLeague && nextLeague) {
                    const progress = ((userData.monthlyXP - league.minXP) / (nextLeague.minXP - league.minXP)) * 100;
                    progressHTML = `
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-3">
                            <div class="bg-cyan-400 h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">${userData.monthlyXP} / ${nextLeague.minXP} XP to ${nextLeague.name}</p>
                    `;
                }

                const leagueCard = document.createElement('div');
                leagueCard.className = `cyber-card p-6 rounded-lg text-center flex flex-col`;
                leagueCard.innerHTML = `
                    <div class="flex-grow">
                        <img src="${league.iconUrl}" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 ${isCurrentLeague ? 'border-cyan-400' : 'border-gray-700'}">
                        <h3 class="text-2xl font-bold text-white font-orbitron">${league.name}</h3>
                        <p class="text-gray-400">Requires ${league.minXP} XP</p>
                        <p class="mt-2 text-cyan-300 font-semibold">${playersInLeague} Operatives</p>
                        ${progressHTML}
                    </div>
                    <button class="view-operatives-btn cyber-button text-cyan-300 font-bold py-2 px-4 rounded-lg mt-4" data-league-id="${league.id}">View Operatives</button>
                `;
                container.appendChild(leagueCard);
            });
        }

        function renderInventoryPage() {
            const avatarGrid = document.getElementById('inventory-avatars-grid');
            const titlesList = document.getElementById('inventory-titles-list');
            if(!avatarGrid || !titlesList || !userData) return;

            avatarGrid.innerHTML = '';
            userData.unlockedAvatars.forEach(avatarId => {
                const avatar = AVATAR_OPTIONS.find(a => a.id === avatarId);
                if (avatar) {
                    const isSelected = userData.profilePicUrl === avatar.url;
                    const avatarEl = document.createElement('div');
                    avatarEl.className = `relative cyber-card p-2 rounded-lg flex items-center justify-center ${isSelected ? 'border-cyan-400 border-2' : ''}`;
                    avatarEl.innerHTML = `
                        <img src="${avatar.url}" class="w-24 h-24 rounded-lg object-cover">
                        ${isSelected ? '<div class="absolute top-1 right-1 bg-green-500 rounded-full p-1"><i class="fas fa-check text-white"></i></div>' : ''}
                    `;
                    avatarGrid.appendChild(avatarEl);
                }
            });

            titlesList.innerHTML = '';
            if (!userData.unlockedTitles || userData.unlockedTitles.length === 0) {
                 titlesList.innerHTML = '<p class="text-gray-400">No titles unlocked. Visit the shop!</p>';
            }
            userData.unlockedTitles.forEach(titleId => {
                const title = SHOP_ITEMS.find(item => item.id === titleId);
                if (title) {
                    const isEquipped = userData.equippedTitle === title.id;
                    const titleEl = document.createElement('div');
                    titleEl.className = 'cyber-card p-3 rounded-lg flex justify-between items-center';
                    titleEl.innerHTML = `
                        <span class="font-semibold text-white">${title.name.replace('Title: ', '')}</span>
                        <button class="equip-title-btn cyber-button text-sm py-1 px-3 rounded-md ${isEquipped ? 'bg-gray-600/50 text-gray-300' : 'bg-cyan-500/20 text-cyan-300'}" data-title-id="${title.id}" ${isEquipped ? 'disabled' : ''}>
                            ${isEquipped ? 'Equipped' : 'Equip'}
                        </button>
                    `;
                    titlesList.appendChild(titleEl);
                }
            });
            document.querySelectorAll('.equip-title-btn').forEach(btn => {
                if(!btn.disabled) {
                    btn.addEventListener('click', async (e) => {
                        const titleId = e.currentTarget.dataset.titleId;
                        userData.equippedTitle = titleId;
                        checkAchievements('first_title');
                        await saveUserData();
                    });
                }
            })
        }

        function renderShop() {
            const container = document.getElementById('shop-container');
            if (!container || !userData) return;
            container.innerHTML = '';
            SHOP_ITEMS.forEach(item => {
                if (item.hidden) return;
                const isOwned = (item.type === 'avatar' && userData.unlockedAvatars.includes(item.id)) || (item.type === 'title' && userData.unlockedTitles.includes(item.id));
                const itemEl = document.createElement('div');
                const currencyIcon = item.currency === 'sp' ? 'fa-database' : 'fa-coins';
                const currencyColor = item.currency === 'sp' ? 'text-purple-300' : 'text-yellow-300';

                itemEl.className = `cyber-card p-6 rounded-lg text-center ${isOwned ? 'opacity-50' : ''}`;
                itemEl.innerHTML = `
                    ${item.type === 'avatar' ? `<img src="${AVATAR_OPTIONS.find(a => a.id === item.id)?.url}" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-cyan-500">` : `<i class="fas ${item.icon} text-5xl text-yellow-400 mb-4"></i>`}
                    <h3 class="font-bold text-xl text-white">${item.name}</h3>
                    <p class="text-gray-400 mb-4 h-10">${item.description}</p>
                    <button class="cyber-button purchase-item-btn ${currencyColor} font-bold py-2 px-4 rounded-lg" data-item-id="${item.id}" ${isOwned ? 'disabled' : ''}>
                        ${isOwned ? 'Owned' : `<i class="fas ${currencyIcon} mr-2"></i>${item.cost} ${item.currency.toUpperCase()}`}
                    </button>
                `;
                container.appendChild(itemEl);
            });
            document.querySelectorAll('.purchase-item-btn').forEach(btn => {
                if(!btn.disabled) {
                    btn.addEventListener('click', (e) => purchaseShopItem(e.currentTarget.dataset.itemId))
                }
            });
        }

        function renderStudyPass() {
            const container = document.getElementById('study-pass-container');
            if (!container || !userData) return;
            container.innerHTML = '';

            const totalXPNeeded = STUDY_PASS_REWARDS[STUDY_PASS_REWARDS.length - 1].xp;
            const currentPassXP = userData.monthlyXP;
            const passPercentage = totalXPNeeded > 0 ? (currentPassXP / totalXPNeeded) * 100 : 0;
            document.getElementById('pass-progress-bar').style.width = `${Math.min(100, passPercentage)}%`;
            document.getElementById('pass-progress-text').textContent = `${Math.min(totalXPNeeded, currentPassXP)} / ${totalXPNeeded} XP`;


            STUDY_PASS_REWARDS.forEach((tier, index) => {
                const isClaimed = userData.studyPassProgress.claimedTiers.includes(index);
                const isUnlocked = userData.monthlyXP >= tier.xp;
                const tierEl = document.createElement('div');
                const displayTierNumber = index + 1;

                tierEl.className = `cyber-card p-4 rounded-lg text-center ${!isUnlocked ? 'opacity-50 grayscale' : ''}`;

                let rewardHTML = '';
                if(tier.type === 'coins') rewardHTML = `<p class="text-yellow-300">${tier.value} Coins</p>`;
                if(tier.type === 'sp') rewardHTML = `<p class="text-purple-300">${tier.value} SP</p>`;
                if(tier.type === 'avatar') {
                    const avatar = AVATAR_OPTIONS.find(a => a.id === tier.value);
                    rewardHTML = `<img src="${avatar.url}" class="w-16 h-16 rounded-full mx-auto my-2 border-2 border-cyan-400">`;
                }

                tierEl.innerHTML = `
                    <h4 class="font-bold text-xl text-white">Tier ${displayTierNumber}</h4>
                    <p class="text-gray-400">Requires: ${tier.xp} XP</p>
                    ${rewardHTML}
                    <button class="cyber-button claim-pass-btn mt-2 py-1 px-3 rounded-lg
                        ${isClaimed ? 'bg-gray-600/50 text-gray-300' : 'bg-green-500/20 text-green-300'}
                        " data-tier-index="${index}" ${!isUnlocked || isClaimed ? 'disabled' : ''}>
                        ${isClaimed ? 'Claimed <i class="fas fa-check"></i>' : (isUnlocked ? 'Claim Reward' : 'Locked <i class="fas fa-lock"></i>')}
                    </button>
                `;
                container.appendChild(tierEl);
            });
             document.querySelectorAll('.claim-pass-btn').forEach(btn => btn.addEventListener('click', (e) => claimStudyPassReward(parseInt(e.currentTarget.dataset.tierIndex))));
        }

        function renderAchievements() {
            const container = document.getElementById('achievements-container');
            if (!container || !userData.achievements) return;
            container.innerHTML = '';

            const rarityOrder = { 'Mythic': 1, 'Legendary': 2, 'Rare': 3, 'Common': 4 };
            const rarityToClass = {
                'Common': 'rarity-common',
                'Rare': 'rarity-rare',
                'Legendary': 'rarity-legendary',
                'Mythic': 'rarity-mythic'
            };

            const achievedList = (userData.achievements || []).filter(a => a.achieved)
                .sort((a, b) => (rarityOrder[a.rarity] || 5) - (rarityOrder[b.rarity] || 5));
            const unachievedList = (userData.achievements || []).filter(a => !a.achieved)
                .sort((a, b) => (rarityOrder[a.rarity] || 5) - (rarityOrder[b.rarity] || 5));
            const sortedAchievements = [...achievedList, ...unachievedList];


            sortedAchievements.forEach(achievement => {
                const rarityClass = rarityToClass[achievement.rarity] || 'text-cyan-400';
                const achEl = document.createElement('div');
                achEl.className = `cyber-card p-4 rounded-lg text-center flex flex-col justify-between ${!achievement.achieved ? 'opacity-50' : ''}`;
                achEl.innerHTML = `
                    <div>
                        <i class="fas ${achievement.icon} text-4xl mb-2 ${rarityClass}"></i>
                        <h4 class="font-bold text-lg text-white break-words min-h-[3.5rem] flex items-center justify-center">${achievement.name}</h4>
                        <p class="text-gray-400 text-sm">${achievement.description}</p>
                    </div>
                    ${achievement.achieved
                        ? `<span class="font-bold mt-2 block ${rarityClass}">Achieved!</span>`
                        : '<span class="text-gray-500 font-bold mt-2 block">Not Achieved</span>'
                    }
                `;
                container.appendChild(achEl);
            });
        }

        function renderSeasonHistory() {
            const container = document.getElementById('season-history-container');
            if (!container || !userData || !userData.seasonHistory) {
                if(container) container.innerHTML = '<p class="text-gray-400">No season history available.</p>';
                return;
            };

            const history = userData.seasonHistory;
            const seasonIds = Object.keys(history).sort().reverse();

            if (seasonIds.length === 0) {
                container.innerHTML = '<p class="text-gray-400">No season history available.</p>';
                return;
            }

            container.innerHTML = '';
            seasonIds.forEach(seasonId => {
                const seasonData = history[seasonId];
                const [year, month] = seasonId.split('-');
                const seasonDate = new Date(year, month);
                const seasonName = seasonDate.toLocaleString('default', { month: 'long', year: 'numeric' });

                const historyEl = document.createElement('div');
                historyEl.className = 'cyber-card p-4 rounded-lg flex items-center justify-between';
                historyEl.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg text-white">${seasonName}</h4>
                        <p class="text-sm text-gray-400">Highest League: <span class="font-semibold text-cyan-300">${seasonData.league}</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold font-orbitron text-white">${seasonData.xp} XP</p>
                    </div>
                `;
                container.appendChild(historyEl);
            });
        }


        function updateDailyQuote() {
            const today = new Date().toDateString();
            if (userData && userData.lastQuoteDate === today && userData.currentQuoteText) {
                document.getElementById('quote-text').textContent = userData.currentQuoteText;
                document.getElementById('quote-author').textContent = `- ${userData.currentQuoteAuthor}`;
                return;
            }

            const randomIndex = Math.floor(Math.random() * QUOTES.length);
            const quote = QUOTES[randomIndex];
            document.getElementById('quote-text').textContent = quote.text;
            document.getElementById('quote-author').textContent = `- ${quote.author}`;

            if(userData) {
                userData.currentQuoteText = quote.text;
                userData.currentQuoteAuthor = quote.author;
                userData.lastQuoteDate = today;
                if (auth.currentUser) saveUserData();
            }
        }

        function renderAvatarSelectionModal() {
            const modal = document.getElementById('avatar-selection-modal');
            const grid = document.getElementById('avatar-grid');
            if (!modal || !grid || !userData) return;

            grid.innerHTML = '';
            AVATAR_OPTIONS.forEach(avatar => {
                const isUnlocked = userData.unlockedAvatars.includes(avatar.id);
                const isSelected = userData.profilePicUrl === avatar.url;

                const avatarEl = document.createElement('div');
                avatarEl.className = `relative rounded-full p-1 border-2 ${isSelected ? 'border-cyan-400' : 'border-transparent'}`;
                avatarEl.innerHTML = `
                    <img src="${avatar.url}" class="w-24 h-24 rounded-full object-cover ${isUnlocked ? 'cursor-pointer hover:opacity-80' : 'opacity-40 grayscale'}">
                    ${!isUnlocked ? '<div class="absolute inset-0 bg-black/60 flex items-center justify-center rounded-full"><i class="fas fa-lock text-2xl text-red-500"></i></div>' : ''}
                `;
                if(isUnlocked) {
                    avatarEl.addEventListener('click', async () => {
                        userData.profilePicUrl = avatar.url;
                        await saveUserData();
                        modal.style.display = 'none';
                    });
                }
                grid.appendChild(avatarEl);
            });
            modal.style.display = 'flex';
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const header = document.getElementById('month-year-header');
            if (!grid || !header || !userData) return;

            grid.innerHTML = '';
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();

            header.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                grid.innerHTML += `<div class="font-bold text-cyan-300">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasTasks = userData.tasks[dateString] && userData.tasks[dateString].length > 0;
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();

                // NEW: Check for labels and events
                const dayLabel = userData.dayLabels[dateString];
                let hasEvents = false; // Default to false
                // FIX: Add check to ensure userData.events is an array
                if (Array.isArray(userData.events)) {
                    hasEvents = userData.events.some(event => event.date === dateString); // This line caused the error
                } else {
                    console.error("userData.events is not an array in renderCalendar. Value:", userData.events);
                }


                let labelIcon = '';
                if (dayLabel === 'productive') {
                    labelIcon = '<i class="fas fa-chart-line label-productive calendar-day-label" title="Productive Day"></i>';
                } else if (dayLabel === 'wasted') {
                    labelIcon = '<i class="fas fa-couch label-wasted calendar-day-label" title="Wasted Day"></i>';
                } else if (dayLabel === 'holiday') {
                    labelIcon = '<i class="fas fa-umbrella-beach label-holiday calendar-day-label" title="Holiday"></i>';
                }

                const eventIndicator = hasEvents ? '<div class="calendar-event-indicator" title="Event"></div>' : '';

                const dayEl = document.createElement('div');
                dayEl.dataset.date = dateString;
                dayEl.className = `calendar-day-cell p-2 rounded-lg cursor-pointer hover:bg-cyan-500/20 ${isToday ? 'bg-cyan-500/30 font-bold' : ''} ${hasTasks ? 'border border-cyan-400' : ''} ${hasEvents ? 'border-purple-400' : ''}`;
                dayEl.innerHTML = `${day} ${labelIcon} ${eventIndicator}`;

                dayEl.addEventListener('click', () => {
                    const selectedDate = dayEl.dataset.date;
                    const dateObj = new Date(selectedDate + 'T00:00:00');
                    const todayObj = new Date();
                    todayObj.setHours(0, 0, 0, 0);

                    document.querySelectorAll('#calendar-grid > div[data-date]').forEach(d => d.classList.remove('bg-cyan-500/40'));
                    dayEl.classList.add('bg-cyan-500/40');

                    document.getElementById('calendar-task-controls').classList.remove('hidden');

                    const canAddTasks = dateObj >= todayObj;
                    document.getElementById('calendar-add-task-btn').classList.toggle('hidden', !canAddTasks);
                    document.getElementById('calendar-add-task-btn').dataset.date = selectedDate;

                    // NEW: Set data-date for new buttons
                    document.getElementById('calendar-set-label-btn').dataset.date = selectedDate;
                    document.getElementById('calendar-create-event-btn').dataset.date = selectedDate;

                    document.getElementById('selected-date-span').textContent = dateObj.toLocaleDateString();
                    renderTasks(selectedDate);
                });
                grid.appendChild(dayEl);
            }
        }

        // --- SOCIAL FEATURES ---

        function showPermissionErrorAlert() {
            const rule = `
match /artifacts/{appId}/public/data/friend_requests/{requestId} {
    allow read, create, update, delete: if request.auth != null;
}`;
            showConfirmModal("Firestore Permission Error: The social features require a security rule update. See console for details.", null, true);
            console.warn("Please add the following rule to your Firestore project to allow friend requests:\n" + rule);
        }

        function setupSocialListeners() {
            if (!auth.currentUser) return;
            socialListeners.forEach(unsub => unsub());
            socialListeners = [];

            const requestsRef = collection(db, `artifacts/${appId}/public/data/friend_requests`);
            const incomingQuery = query(requestsRef, where("receiverId", "==", auth.currentUser.uid), where("status", "==", "pending"));
            const unsubIncoming = onSnapshot(incomingQuery,
                (snapshot) => {
                    incomingRequestsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSocialPage();
                },
                (error) => {
                    console.error("Error on incoming requests listener:", error);
                    if (error.code === 'permission-denied') {
                        showPermissionErrorAlert();
                    }
                }
            );
            socialListeners.push(unsubIncoming);

            const acceptedQuery = query(requestsRef, where("senderId", "==", auth.currentUser.uid), where("status", "==", "accepted"));
            const unsubAccepted = onSnapshot(acceptedQuery,
                (snapshot) => {
                    snapshot.docs.forEach(async (requestDoc) => {
                        const request = requestDoc.data();
                        const friends = userData.friends || [];
                        if (!friends.includes(request.receiverId)) {
                            checkAchievements('first_friend');
                            const userRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                            await updateDoc(userRef, {
                                friends: arrayUnion(request.receiverId)
                            });
                        }
                        await deleteDoc(requestDoc.ref);
                    });
                },
                (error) => {
                    console.error("Error on accepted requests listener:", error);
                     if (error.code === 'permission-denied') {
                        showPermissionErrorAlert();
                    }
                }
            );
            socialListeners.push(unsubAccepted);
        }

        function renderSocialPage() {
            if (!userData) return;

            const requestsContainer = document.getElementById('friend-requests-container');
            const friendsContainer = document.getElementById('friends-list-container');

            requestsContainer.innerHTML = '';
            if (incomingRequestsCache.length === 0) {
                requestsContainer.innerHTML = '<p class="text-gray-400">No new friend requests.</p>';
            } else {
                incomingRequestsCache.forEach(req => {
                    const requestEl = document.createElement('div');
                    requestEl.className = 'cyber-card p-3 rounded-lg flex items-center justify-between';
                    requestEl.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${req.senderProfilePic}" class="w-10 h-10 rounded-full object-cover">
                            <span class="font-semibold">${req.senderName}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="accept-friend-btn cyber-button text-sm bg-green-500/20 text-green-300 py-1 px-3 rounded-md" data-request-id="${req.id}" data-sender-id="${req.senderId}"><i class="fas fa-check"></i></button>
                            <button class="decline-friend-btn cyber-button text-sm bg-red-500/20 text-red-300 py-1 px-3 rounded-md" data-request-id="${req.id}"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    requestsContainer.appendChild(requestEl);
                });
            }

            friendsContainer.innerHTML = '';
            const friends = userData.friends || [];
            if (friends.length === 0) {
                friendsContainer.innerHTML = '<p class="text-gray-400">Find operatives to add them as friends.</p>';
            } else {
                friends.forEach(userId => {
                    const user = allUsersCache.find(u => u.id === userId);
                     if (user) {
                        const friendEl = document.createElement('div');
                        friendEl.className = 'cyber-card p-3 rounded-lg flex items-center justify-between';
                        friendEl.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${user.profilePicUrl}" class="w-10 h-10 rounded-full object-cover">
                                <span class="font-semibold">${user.displayName}</span>
                            </div>
                             <div>
                                <button class="view-profile-btn cyber-button text-sm bg-cyan-500/20 text-cyan-300 py-1 px-3 rounded-md" data-user-id="${user.id}">View Profile</button>
                            </div>
                        `;
                        friendsContainer.appendChild(friendEl);
                    }
                });
            }
        }

        async function sendFriendRequest(receiverId) {
            if (!auth.currentUser || auth.currentUser.uid === receiverId) return;

            try {
                const requestsRef = collection(db, `artifacts/${appId}/public/data/friend_requests`);
                const q = query(requestsRef,
                    where("senderId", "==", auth.currentUser.uid),
                    where("receiverId", "==", receiverId)
                );
                const existingRequest = await getDocs(q);

                if (!existingRequest.empty) {
                    showConfirmModal("You have already sent a friend request to this user.", null, true);
                    return;
                }

                await addDoc(requestsRef, {
                    senderId: auth.currentUser.uid,
                    senderName: userData.displayName,
                    senderProfilePic: userData.profilePicUrl,
                    receiverId: receiverId,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                showConfirmModal('Friend request sent!', null, true);
                handleUserSearch({ target: document.getElementById('user-search-input') });
            } catch(e) {
                console.error("Error sending friend request: ", e);
                if (e.code === 'permission-denied') {
                    showPermissionErrorAlert();
                }
            }
        }

        async function acceptFriendRequest(requestId, senderId) {
            if (!auth.currentUser || !requestId || !senderId) return;

            try {
                checkAchievements('first_friend');
                const currentUserRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                await updateDoc(currentUserRef, {
                    friends: arrayUnion(senderId)
                });

                const requestRef = doc(db, `artifacts/${appId}/public/data/friend_requests/${requestId}`);
                await updateDoc(requestRef, {
                    status: 'accepted'
                });
            } catch(e) {
                console.error("Error accepting friend request: ", e);
                if (e.code === 'permission-denied') {
                    showPermissionErrorAlert();
                }
            }
        }

        async function declineFriendRequest(requestId) {
            if (!requestId) return;
            try {
                const requestRef = doc(db, `artifacts/${appId}/public/data/friend_requests/${requestId}`);
                await deleteDoc(requestRef);
            } catch(e) {
                 console.error("Error declining friend request: ", e);
                 if (e.code === 'permission-denied') {
                    showPermissionErrorAlert();
                }
            }
        }

        async function handleUserSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('user-search-results');
            resultsContainer.innerHTML = '';
            if (searchTerm.length < 2) return;

            const results = allUsersCache.filter(user =>
                user.displayName.toLowerCase().includes(searchTerm) &&
                user.id !== auth.currentUser.uid
            );

            try {
                const requestsRef = collection(db, `artifacts/${appId}/public/data/friend_requests`);
                const q = query(requestsRef, where("senderId", "==", auth.currentUser.uid), where("status", "==", "pending"));
                const sentRequestsSnap = await getDocs(q);
                const sentRequestIds = sentRequestsSnap.docs.map(doc => doc.data().receiverId);

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-400">No operatives found.</p>';
                } else {
                    results.slice(0, 5).forEach(user => {
                        const isFriend = userData.friends?.includes(user.id);
                        const hasSentRequest = sentRequestIds.includes(user.id);
                        const hasReceivedRequest = incomingRequestsCache.some(req => req.senderId === user.id);

                        let buttonHTML = '';
                        if (isFriend) {
                            buttonHTML = `<button class="cyber-button text-sm bg-gray-500/20 text-gray-300 py-1 px-3 rounded-md" disabled>Friends</button>`;
                        } else if (hasSentRequest) {
                            buttonHTML = `<button class="cyber-button text-sm bg-gray-500/20 text-gray-300 py-1 px-3 rounded-md" disabled>Pending</button>`;
                        } else if (hasReceivedRequest) {
                            const req = incomingRequestsCache.find(r => r.senderId === user.id);
                            buttonHTML = `<button class="accept-friend-btn cyber-button text-sm bg-green-500/20 text-green-300 py-1 px-3 rounded-md" data-request-id="${req.id}" data-sender-id="${user.id}">Accept</button>`;
                        } else {
                            buttonHTML = `<button class="add-friend-btn cyber-button text-sm bg-cyan-500/20 text-cyan-300 py-1 px-3 rounded-md" data-user-id="${user.id}">Add Friend</button>`;
                        }

                        const resultEl = document.createElement('div');
                        resultEl.className = 'cyber-card p-3 rounded-lg flex items-center justify-between';
                        resultEl.innerHTML = `
                             <div class="flex items-center gap-3">
                                 <img src="${user.profilePicUrl}" class="w-10 h-10 rounded-full object-cover">
                                 <span class="font-semibold">${user.displayName}</span>
                            </div>
                            <div>
                                <button class="view-profile-btn cyber-button text-sm bg-blue-500/20 text-blue-300 py-1 px-3 rounded-md mr-2" data-user-id="${user.id}">Profile</button>
                                ${buttonHTML}
                            </div>
                        `;
                        resultsContainer.appendChild(resultEl);
                    });
                }
            } catch(e) {
                console.error("Error during user search: ", e);
                if (e.code === 'permission-denied') {
                    showPermissionErrorAlert();
                }
            }
        }

        function renderUserProfileModal(userId) {
            const user = allUsersCache.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('user-profile-modal');
            const content = document.getElementById('user-profile-content-wrapper'); // Target the wrapper now

            const allPlayers = [...allUsersCache, ...botsData];
            allPlayers.sort((a, b) => b.monthlyXP - a.monthlyXP);
            const rank = allPlayers.findIndex(p => p.uid === userId || p.id === userId) + 1;


            const userLeague = LEAGUES.slice().reverse().find(l => user.monthlyXP >= l.minXP) || LEAGUES[0];

            const displayTier = STUDY_PASS_REWARDS.filter(tier => user.monthlyXP >= tier.xp).length;

            const equippedTitle = SHOP_ITEMS.find(item => item.id === user.equippedTitle && item.type === 'title');
            const titleHTML = equippedTitle ? `<span class="ml-4 text-lg font-bold bg-gradient-to-r from-purple-400 to-pink-500 text-white px-3 py-1 rounded-full">${equippedTitle.name.replace('Title: ', '')}</span>` : '';

            content.innerHTML = `
                <div>
                    <div class="flex items-start space-x-6">
                        <img src="${user.profilePicUrl}" class="w-24 h-24 rounded-full border-4 border-cyan-400 object-cover">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <h3 class="text-3xl font-bold font-orbitron text-white">${user.displayName}</h3>
                                ${titleHTML}
                            </div>
                            <div class="flex items-center gap-4 mt-2 text-gray-300">
                               <span class="font-bold text-md font-orbitron bg-cyan-900/50 border-2 border-cyan-400/50 px-3 py-1 rounded-lg">LEVEL ${user.level}</span>
                               <span class="flex items-center gap-2"><img src="${userLeague.iconUrl}" class="w-6 h-6 rounded-full">${userLeague.name}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-pink-900/50 to-gray-900/30">
                            <p class="text-sm text-pink-300 flex items-center justify-center gap-2"><i class="fas fa-moon"></i> Monthly</p>
                            <p class="text-xl font-bold font-orbitron text-white">${user.monthlyXP || 0}</p>
                        </div>
                         <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-yellow-900/50 to-gray-900/30">
                            <p class="text-sm text-yellow-300 flex items-center justify-center gap-2"><i class="fas fa-fire"></i> Total</p>
                            <p class="text-xl font-bold font-orbitron text-white">${user.totalXP || 0}</p>
                        </div>
                         <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-purple-900/50 to-gray-900/30">
                            <p class="text-sm text-purple-300 flex items-center justify-center gap-2"><i class="fas fa-trophy"></i> Rank</p>
                            <p class="text-xl font-bold font-orbitron text-white">${rank > 0 ? `#${rank}` : 'N/A'}</p>
                        </div>
                        <div class="cyber-card p-3 rounded-lg text-center bg-gradient-to-br from-green-900/50 to-gray-900/30">
                            <p class="text-sm text-green-300 flex items-center justify-center gap-2"><i class="fas fa-gem"></i> Pass Tier</p>
                            <p class="text-xl font-bold font-orbitron text-white">${displayTier}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h4 class="text-2xl font-bold mb-3 text-white font-orbitron">Achievements</h4>
                    <div id="modal-achievements-container" class="grid grid-cols-4 gap-3"></div>
                </div>

                 <p class="text-xs text-gray-500 mt-6 text-center">Note: Mission history and daily XP are private and not visible to other operatives.</p>
            `;

            const achievementsContainer = content.querySelector('#modal-achievements-container');
            const userAchievements = user.achievements || [];
            const rarityOrder = { 'Mythic': 1, 'Legendary': 2, 'Rare': 3, 'Common': 4 };
            const rarityToClass = {
                'Common': 'rarity-common',
                'Rare': 'rarity-rare',
                'Legendary': 'rarity-legendary',
                'Mythic': 'rarity-mythic'
            };

            const achievedList = (userAchievements || []).filter(a => a.achieved)
                .sort((a, b) => (rarityOrder[a.rarity] || 5) - (rarityOrder[b.rarity] || 5));
            const unachievedList = (userAchievements || []).filter(a => !a.achieved)
                .sort((a, b) => (rarityOrder[a.rarity] || 5) - (rarityOrder[b.rarity] || 5));
            const sortedAchievements = [...achievedList, ...unachievedList];


             sortedAchievements.slice(0, 50).forEach(achievement => {
                const rarityClass = rarityToClass[achievement.rarity] || 'text-cyan-400';
                const achEl = document.createElement('div');
                achEl.className = `cyber-card p-3 rounded-lg text-center flex flex-col justify-between ${!achievement.achieved ? 'opacity-50' : ''}`;
                achEl.innerHTML = `
                    <div>
                        <i class="fas ${achievement.icon} text-3xl mb-1 ${rarityClass}"></i>
                        <h5 class="font-semibold text-sm text-white break-words min-h-[2.5rem] flex items-center justify-center">${achievement.name}</h5>
                    </div>
                    ${achievement.achieved
                        ? `<span class="font-bold text-xs mt-1 block ${rarityClass}">Achieved!</span>`
                        : '<span class="text-gray-500 font-bold text-xs mt-1 block">Not Achieved</span>'
                    }
                `;
                achievementsContainer.appendChild(achEl);
            });

            modal.style.display = 'flex';
        }

        function renderLeagueMembersModal(leagueId) {
            const league = LEAGUES.find(l => l.id === leagueId);
            if (!league) return;

            const leagueIndex = LEAGUES.findIndex(l => l.id === leagueId);
            const nextLeague = LEAGUES[leagueIndex + 1];

            const allPlayers = [...allUsersCache, ...botsData];
            const playersInLeague = allPlayers.filter(p => {
                const xp = p.monthlyXP || 0;
                if (nextLeague) {
                    return xp >= league.minXP && xp < nextLeague.minXP;
                }
                return xp >= league.minXP; // For the top league
            });

            playersInLeague.sort((a, b) => (b.monthlyXP || 0) - (a.monthlyXP || 0));

            const modal = document.getElementById('league-members-modal');
            const titleEl = document.getElementById('league-modal-title');
            const listEl = document.getElementById('league-members-list');

            titleEl.innerHTML = `<img src="${league.iconUrl}" class="w-8 h-8 rounded-full"> Operatives in ${league.name} League`;
            listEl.innerHTML = '';

            if (playersInLeague.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-center p-4">This league is currently empty.</p>';
            } else {
                playersInLeague.forEach((player, index) => {
                    // --- Get Title Icon HTML ---
                    let titleIconHTML = '';
                    if(player.isBot){
                         titleIconHTML = `<i class="fas fa-microchip text-gray-500 ml-2"></i>`;
                    } else {
                        const equippedTitle = SHOP_ITEMS.find(item => item.id === player.equippedTitle && item.type === 'title');
                        if (equippedTitle) {
                            let iconClass = 'text-cyan-400'; // Default
                            if (equippedTitle.id === 'title_founder') iconClass = 'founder-title';
                            if (equippedTitle.id === 'title_verified') iconClass = 'verified-title';
                            titleIconHTML = `<i class="fas ${equippedTitle.icon} ${iconClass} ml-2"></i>`;
                        }
                    }
                    // --- End Title Icon HTML ---

                    const playerEl = document.createElement('div');
                    playerEl.className = 'cyber-card p-3 rounded-lg flex items-center justify-between';
                    playerEl.innerHTML = `
                        <div class="flex items-center gap-4">
                            <span class="font-bold font-orbitron text-lg w-8 text-center">${index + 1}</span>
                            <img src="${player.profilePicUrl || ''}" class="w-10 h-10 rounded-full object-cover">
                             <div class="flex items-center"> <!-- Ensure name and icon are grouped -->
                                <span class="font-semibold">${player.displayName || player.name}</span>
                                ${titleIconHTML} <!-- Display the icon -->
                            </div>
                        </div>
                        <span class="font-bold font-orbitron text-cyan-300">${player.monthlyXP || 0} XP</span>
                    `;
                    listEl.appendChild(playerEl);
                });
            }

            modal.style.display = 'flex';
        }


        // --- NEW/MODIFIED TASK & MODAL FUNCTIONS ---
        function openAddTaskModal(dateString) {
            const form = document.getElementById('add-task-form');
            form.reset();

            document.getElementById('task-id').value = '';
            document.getElementById('task-date').value = dateString || getTodayDateString();

            document.getElementById('task-modal-title').textContent = 'Add New Mission';
            document.getElementById('save-task-btn').textContent = 'Add Mission';
            document.getElementById('other-subject-container').classList.add('hidden');

            document.getElementById('add-task-modal').style.display = 'flex';
        }

        function openEditTaskModal(taskId, taskDate) {
            const task = userData.tasks[taskDate]?.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('task-modal-title').textContent = 'Edit Mission';
            document.getElementById('save-task-btn').textContent = 'Save Changes';

            document.getElementById('task-id').value = taskId;
            document.getElementById('task-date').value = taskDate;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-duration').value = task.duration;

            const subjectSelect = document.getElementById('task-subject');
            const otherSubjectContainer = document.getElementById('other-subject-container');
            const otherSubjectInput = document.getElementById('task-subject-other');
            const options = Array.from(subjectSelect.options).map(opt => opt.value);
            if (options.includes(task.subject)) {
                subjectSelect.value = task.subject;
                otherSubjectContainer.classList.add('hidden');
            } else {
                subjectSelect.value = 'other';
                otherSubjectInput.value = task.subject;
                otherSubjectContainer.classList.remove('hidden');
            }

            document.getElementById('add-task-modal').style.display = 'flex';
        }

        // NEW: Event Modal Functions
        function openCreateEventModal(dateString) {
            const form = document.getElementById('event-form');
            form.reset();

            document.getElementById('event-id').value = '';
            document.getElementById('event-date').value = dateString || getTodayDateString();

            document.getElementById('event-modal-title').textContent = 'Create New Event';
            document.getElementById('save-event-btn').textContent = 'Create Event';

            document.getElementById('event-modal').style.display = 'flex';
        }

        function openEditEventModal(eventId) {
            // FIX: Add check for Array.isArray
            if (!Array.isArray(userData.events)) {
                console.error("Cannot edit event, userData.events is not an array");
                return;
            }
            const event = userData.events.find(e => e.id === eventId);
            if (!event) return;

            document.getElementById('event-modal-title').textContent = 'Edit Event';
            document.getElementById('save-event-btn').textContent = 'Save Changes';

            document.getElementById('event-id').value = event.id;
            document.getElementById('event-title').value = event.title;
            document.getElementById('event-date').value = event.date;
            document.getElementById('event-time').value = event.time || '';
            document.getElementById('event-description').value = event.description || '';

            document.getElementById('event-modal').style.display = 'flex';
        }

        // NEW: Day Label Modal Function
        function openDayLabelModal(dateString) {
            const dateObj = new Date(dateString + 'T00:00:00');
            document.getElementById('day-label-modal-date').textContent = dateObj.toLocaleDateString();
            document.getElementById('day-label-date').value = dateString;
            document.getElementById('day-label-modal').style.display = 'flex';
        }


        function showConfirmModal(message, onConfirm, isAlert = false) {
            const modal = document.getElementById('confirm-modal');
            const text = document.getElementById('confirm-modal-text');
            const title = document.getElementById('confirm-modal-title');
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');

            text.textContent = message;
            confirmCallback = onConfirm;

            if (isAlert) {
                title.textContent = "Notification";
                confirmBtn.classList.add('hidden');
                cancelBtn.textContent = 'Close';
            } else {
                title.textContent = "Confirm Action";
                confirmBtn.classList.remove('hidden');
                cancelBtn.textContent = 'Cancel';
            }

            modal.style.display = 'flex';
        }

        function handleTaskAction(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const taskId = button.dataset.taskId;
            const taskDate = button.dataset.taskDate;

            if (button.classList.contains('task-edit-btn')) {
                openEditTaskModal(taskId, taskDate);
            } else if (button.classList.contains('task-partial-btn')) {
                completeTask(taskId, taskDate, 'partial');
            } else if (button.classList.contains('task-full-btn')) {
                completeTask(taskId, taskDate, 'completed');
            } else if (button.classList.contains('task-delete-btn')) {
                showConfirmModal('Are you sure you want to delete this mission? This cannot be undone.', () => {
                    deleteTask(taskId, taskDate);
                });
            }
        }

        // NEW: Handle Event Action (Dashboard)
        function handleEventAction(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const eventId = button.dataset.eventId;

            if (button.classList.contains('event-edit-btn')) {
                openEditEventModal(eventId);
            } else if (button.classList.contains('event-delete-btn')) {
                // FIX: Add check for Array.isArray before filtering
                 if (!Array.isArray(userData.events)) {
                     console.error("Cannot delete event, userData.events is not an array");
                     return;
                 }
                showConfirmModal('Are you sure you want to delete this event?', () => {
                    userData.events = userData.events.filter(event => event.id !== eventId);
                    saveUserData();
                });
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Auth
            document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
            document.getElementById('sign-out-btn').addEventListener('click', signOutUser);
            document.getElementById('first-time-setup-form').addEventListener('submit', handleFirstTimeSetup);

            document.getElementById('auth-toggle-text').addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                const usernameInput = document.getElementById('username-input');

                usernameInput.classList.toggle('hidden', isLoginMode);
                usernameInput.required = !isLoginMode;

                document.getElementById('email-input').placeholder = isLoginMode ? 'Email' : 'Email (for account recovery)';
                document.getElementById('auth-title').textContent = isLoginMode ? 'Login' : 'Create Account';
                document.getElementById('auth-submit-btn').textContent = isLoginMode ? 'Sign In' : 'Create Account';
                document.getElementById('auth-toggle-text').textContent = isLoginMode ? "Don't have an account? Create one" : "Already have an account? Sign In";
            });

            // Social Features
            document.getElementById('user-search-input').addEventListener('keyup', (e) => handleUserSearch(e));

            document.getElementById('social').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.classList.contains('add-friend-btn')) {
                    sendFriendRequest(target.dataset.userId);
                }
                if (target.classList.contains('accept-friend-btn')) {
                    acceptFriendRequest(target.dataset.requestId, target.dataset.senderId);
                }
                if (target.classList.contains('decline-friend-btn')) {
                    declineFriendRequest(target.dataset.requestId);
                }
                if (target.classList.contains('view-profile-btn')) {
                    renderUserProfileModal(target.dataset.userId);
                }
            });
            document.getElementById('close-user-profile-modal-btn').addEventListener('click', () => {
                 document.getElementById('user-profile-modal').style.display = 'none';
            });

            // Avatar Selection
            document.getElementById('profile-avatar-container').addEventListener('click', renderAvatarSelectionModal);
            document.getElementById('close-avatar-modal-btn').addEventListener('click', () => {
                document.getElementById('avatar-selection-modal').style.display = 'none';
            });

            // Calendar Navigation & Task Adding
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('calendar-add-task-btn').addEventListener('click', (e) => {
                openAddTaskModal(e.currentTarget.dataset.date);
            });
            // NEW: Calendar control buttons
            document.getElementById('calendar-set-label-btn').addEventListener('click', (e) => {
                openDayLabelModal(e.currentTarget.dataset.date);
            });
            document.getElementById('calendar-create-event-btn').addEventListener('click', (e) => {
                openCreateEventModal(e.currentTarget.dataset.date);
            });


            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetId = e.currentTarget.getAttribute('href').substring(1);
                    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                    document.getElementById(targetId).classList.remove('hidden');
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-cyan-500/20'));
                    e.currentTarget.classList.add('bg-cyan-500/20');
                    document.getElementById('page-title').textContent = e.currentTarget.querySelector('.nav-text').textContent;

                    if (targetId === 'social') {
                        setupSocialListeners();
                    } else if (targetId === 'calendar') {
                         renderCalendar();
                         document.getElementById('calendar-tasks-container').innerHTML = '';
                         document.getElementById('calendar-task-controls').classList.add('hidden');
                    }

                    updateUI();
                });
            });

            // Task Modal
            document.getElementById('add-task-btn').addEventListener('click', () => openAddTaskModal(getTodayDateString()));
            document.getElementById('cancel-add-task-btn').addEventListener('click', () => document.getElementById('add-task-modal').style.display = 'none');

            const subjectSelect = document.getElementById('task-subject');
            const otherSubjectContainer = document.getElementById('other-subject-container');
            subjectSelect.addEventListener('change', () => {
                otherSubjectContainer.classList.toggle('hidden', subjectSelect.value !== 'other');
            });

            document.getElementById('add-task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const taskId = document.getElementById('task-id').value;
                const taskDate = document.getElementById('task-date').value;
                const title = document.getElementById('task-title').value;
                const duration = document.getElementById('task-duration').value;
                let subject = subjectSelect.value;
                if (subject === 'other') { subject = document.getElementById('task-subject-other').value || 'Other'; }

                if (taskId) {
                    updateTask(taskId, taskDate, { title, duration, subject });
                } else {
                    addTask(title, duration, subject, taskDate);
                }

                document.getElementById('add-task-modal').style.display = 'none';
                e.target.reset();

                if (!document.getElementById('calendar').classList.contains('hidden')) {
                    renderTasks(taskDate);
                    renderCalendar();
                }
            });

            // Task actions (event delegation)
            document.getElementById('daily-tasks-container').addEventListener('click', handleTaskAction);
            document.getElementById('calendar-tasks-container').addEventListener('click', handleTaskAction);

            // NEW: Event actions (event delegation)
            document.getElementById('dashboard-events-container').addEventListener('click', handleEventAction);

            // NEW: Event Modal
            document.getElementById('cancel-event-btn').addEventListener('click', () => document.getElementById('event-modal').style.display = 'none');
            document.getElementById('event-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const eventId = document.getElementById('event-id').value;
                const eventData = {
                    id: eventId || `event_${Date.now()}`,
                    title: document.getElementById('event-title').value,
                    date: document.getElementById('event-date').value,
                    time: document.getElementById('event-time').value || null,
                    description: document.getElementById('event-description').value || null,
                };
                // FIX: Ensure userData.events is an array before modifying
                if (!Array.isArray(userData.events)) {
                    userData.events = [];
                    console.warn("userData.events was not an array in event form submit. Initialized.");
                }

                if (eventId) { // Editing
                    const index = userData.events.findIndex(event => event.id === eventId);
                    if (index > -1) {
                        userData.events[index] = eventData;
                    } else {
                        // Handle case where event to edit wasn't found (maybe deleted elsewhere)
                        console.warn("Event to edit not found, adding as new event:", eventId);
                        userData.events.push(eventData); // Add as new if not found for robustness
                    }
                } else { // Creating
                    userData.events.push(eventData);
                }

                saveUserData();
                document.getElementById('event-modal').style.display = 'none';
                e.target.reset();
                // Re-render relevant UI parts
                if(!document.getElementById('home').classList.contains('hidden')) renderDashboardEvents();
                if(!document.getElementById('calendar').classList.contains('hidden')) renderCalendar();

            });

            // NEW: Day Label Modal
            document.getElementById('day-label-modal').addEventListener('click', (e) => {
                const button = e.target.closest('.day-label-btn');
                if (!button) return;

                const label = button.dataset.label;
                const dateString = document.getElementById('day-label-date').value;

                if (label === 'clear') {
                    delete userData.dayLabels[dateString];
                } else {
                    userData.dayLabels[dateString] = label;
                }

                saveUserData();
                renderCalendar(); // Re-render calendar to show new label
                document.getElementById('day-label-modal').style.display = 'none';
            });

            // Confirmation Modal
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });
            document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });

            // League Members Modal
            document.getElementById('leagues-container').addEventListener('click', (e) => {
                const button = e.target.closest('.view-operatives-btn');
                if (button) {
                    renderLeagueMembersModal(button.dataset.leagueId);
                }
            });
            document.getElementById('close-league-members-modal-btn').addEventListener('click', () => {
                document.getElementById('league-members-modal').style.display = 'none';
            });


            // Update Profile Name
            document.getElementById('update-profile-btn').addEventListener('click', async () => {
                const newName = document.getElementById('profile-name-input').value;
                if (newName && newName.trim() && newName !== userData.displayName) {
                    userData.displayName = newName;
                    await saveUserData();
                    showConfirmModal('Profile name updated!', null, true);
                }
            });
        }
    </script>
</body>
</html>
